<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/">
  <channel>
    <atom:link href="https://newzone.top/rss.xml" rel="self" type="application/rss+xml"/>
    <title>CodeNote</title>
    <link>https://newzone.top/</link>
    <description>开源工具、效率方法、心理学探索的自我提升笔记，记录并输出一切能让自己提升的知识。</description>
    <language>zh-CN</language>
    <pubDate>Thu, 25 Aug 2022 10:13:07 GMT</pubDate>
    <lastBuildDate>Thu, 25 Aug 2022 10:13:07 GMT</lastBuildDate>
    <generator>vuepress-plugin-feed2</generator>
    <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
    <item>
      <title>Linux基础命令</title>
      <link>https://newzone.top/linux/linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4.html</link>
      <guid>https://newzone.top/linux/linux%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4.html</guid>
      <source url="https://newzone.top/rss.xml">Linux基础命令</source>
      <pubDate>Thu, 25 Aug 2022 09:55:40 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="linux基础命令" tabindex="-1"> Linux基础命令</h1>
<h3 id="shell命令" tabindex="-1"> shell命令</h3>
<div><pre><code><span>#查看一级目录文件夹大小</span>
<span>sudo</span> <span>du</span> <span>-h</span> --max-depth<span>=</span><span>1</span>

<span>#查看已删除文件进程</span>
<span>lsof</span> <span>|</span> <span>grep</span> deleted 

<span>#查看发行版</span>
lsb_release <span>-a</span> 

<span>#查看cpu核心数</span>
nproc

<span>#查看cpu型号 “| head -1”是只返回第一个</span>
<span>cat</span> /proc/cpuinfo <span>|</span><span>grep</span> <span>"model name"</span> <span>|</span> <span>head</span> <span>-1</span>

<span>#循环执行一条命令</span>
<span>while</span> <span>true</span><span>;</span> <span>do</span> <span>date</span><span>;</span> <span>sleep</span> <span>1</span><span>;</span> <span>done</span>
<span>watch</span> <span>-n</span> <span>1</span> <span>-d</span> <span>netstat</span> <span>-ant</span>

<span># 统计文本中出现关键字的次数</span>
<span>grep</span> <span>-o</span> objStr  filename<span>|</span><span>wc</span> <span>-l</span>

<span>#kill掉所有符合关键字的进程</span>
<span>ps</span> <span>-ef</span> <span>|</span> <span>grep</span> jobTypeRankDailyData<span>|</span> <span>grep</span> <span>-v</span> <span>grep</span> <span>|</span> <span>cut</span> <span>-c</span> <span>9</span>-15 <span>|</span> <span>xargs</span> <span>kill</span>

<span>ps</span> <span>-ef</span> <span>|</span> <span>grep</span> rabbitmq<span>|</span> <span>grep</span> <span>-v</span> <span>grep</span> <span>|</span> <span>cut</span> <span>-c</span> <span>9</span>-15 <span>|</span> <span>xargs</span> <span>kill</span>

<span>#根据进程id查端口</span>
<span>netstat</span> <span>-nap</span> <span>|</span> <span>grep</span> 进程pid

<span>#根据监听端口查看进程</span>
<span>netstat</span> <span>-ntpl</span> <span>|</span> <span>grep</span> <span>":8755"</span>

<span>#切换用户只执行一条命令的可以用: </span>
<span>su</span> - user <span>-c</span> <span>command</span>
<span>#切换用户执行一个shell文件可以用: </span>
<span>su</span> - user <span>-s</span> /bin/bash shell.sh

<span>#设置环境变量（临时）</span>
<span>export</span> <span>LIBZIP_LIBS</span><span>=</span><span>"/web/software/libzip-1.3.2/lib"</span>
<span>#设置环境变量（永久）(尽量直接编辑，不要echo，容易不小心覆盖文件)</span>
<span>echo</span> <span>"export ONIG_CFLAGS=/usr/bin/onig-config"</span> <span>>></span> /etc/profile
<span>#立即生效</span>
<span>source</span> /etc/profile

<span>#rpm查找包</span>
<span>rpm</span> <span>-q</span> libcurl
<span>#rpm安装包</span>
<span>rpm</span> <span>-ivh</span> libcurl
<span>#rpm卸载包 （ --nodeps忽略依赖）</span>
<span>rpm</span> <span>-e</span> <span>--nodeps</span> libcurl
   
<span>#搜索替换文件内容</span>
<span>sudo</span> <span>sed</span> <span>-i</span> <span>'s/track_errors = On/track_errors = Off/g'</span> /web/software/php-7.4.23/lib/php.ini

<span>#统计文件夹大小（包含文件）</span>
<span>du</span> <span>-h</span> --max-depth<span>=</span><span>1</span> /mysql

<span>#统计当前目录文件按大小排序</span>
<span>du</span> <span>-s</span> * <span>|</span> <span>sort</span> <span>-nr</span>

<span>#批量解压zip文件到指定文件夹</span>
<span>ls</span> *.zip <span>|</span> <span>xargs</span> <span>-n1</span> <span>unzip</span> <span>-o</span> <span>-d</span> unzip/

<span>#批量解压tar压缩文件</span>
<span>ls</span> *.tar.gz <span>|</span> <span>xargs</span> <span>-n1</span> <span>tar</span> <span>-zxvf</span>

<span>#xargs是给命令传递参数的一个过滤器，可以将前一个命令产生的输出作为后一个命令的参数</span>
<span>find</span> test2/ <span>-name</span> <span>'*.tes'</span> <span>|</span><span>xargs</span> <span>rm</span> <span>-rf</span>
<span>#命令即将find产生的输出（test2目录下的所有tes文件），作为rm的参数，从而完全删除</span>

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="shell判断" tabindex="-1"> shell判断</h3>
<div><pre><code><span>if</span> list <span>then</span>
	<span>do</span> something here
<span>elif</span> list <span>then</span>
	<span>do</span> another thing here
<span>else</span>
	<span>do</span> something <span>else</span> here
<span>fi</span>
  
<span>#EX1:</span>
<span>#!/bin/sh</span>

<span>SYSTEM</span><span>=</span><span><span>`</span><span>uname</span> <span>-s</span><span>`</span></span>    <span>#获取操作系统类型，我本地是linux</span>

<span>if</span> <span>[</span> <span>$SYSTEM</span> <span>=</span> <span>"Linux"</span> <span>]</span> <span>;</span> <span>then</span>     <span>#如果是linux的话打印linux字符串</span>
<span>echo</span> <span>"Linux"</span>
<span>elif</span> <span>[</span> <span>$SYSTEM</span> <span>=</span> <span>"FreeBSD"</span> <span>]</span> <span>;</span> <span>then</span>   
<span>echo</span> <span>"FreeBSD"</span>
<span>elif</span> <span>[</span> <span>$SYSTEM</span> <span>=</span> <span>"Solaris"</span> <span>]</span> <span>;</span> <span>then</span>
<span>echo</span> <span>"Solaris"</span>
<span>else</span>
<span>echo</span> <span>"What?"</span>
<span>fi</span>     <span>#ifend</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>基本上和其他脚本语言一样。没有太大区别。不过值得注意的是。[]里面的条件判断。[]内两边要有空格</p>
<p>1 字符串判断</p>
<div><pre><code>str1 <span>=</span> str2　　　　　　当两个串有相同内容、长度时为真
str1 <span>!=</span> str2　　　　　 当串str1和str2不等时为真
<span>-n</span> str1　　　　　　　 当串的长度大于0时为真<span>(</span>串非空<span>)</span>
<span>-z</span> str1　　　　　　　 当串的长度为0时为真<span>(</span>空串<span>)</span>
str1　　　　　　　　   当串str1为非空时为真
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>2 数字的判断</p>
<div><pre><code>int1 <span>-eq</span> int2　　　　两数相等为真
int1 <span>-ne</span> int2　　　　两数不等为真
int1 <span>-gt</span> int2　　　　int1大于int2为真
int1 <span>-ge</span> int2　　　　int1大于等于int2为真
int1 <span>-lt</span> int2　　　　int1小于int2为真
int1 <span>-le</span> int2　　　　int1小于等于int2为真
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>3 文件的判断</p>
<div><pre><code><span>-r</span> <span>file</span>　　　　　用户可读为真
<span>-w</span> <span>file</span>　　　　　用户可写为真
<span>-x</span> <span>file</span>　　　　　用户可执行为真
<span>-f</span> <span>file</span>　　　　　文件为正规文件为真
<span>-d</span> <span>file</span>　　　　　文件为目录为真
<span>-c</span> <span>file</span>　　　　　文件为字符特殊文件为真
<span>-b</span> <span>file</span>　　　　　文件为块特殊文件为真
<span>-s</span> <span>file</span>　　　　　文件大小非0时为真
<span>-t</span> <span>file</span>　　　　　当文件描述符<span>(</span>默认为1<span>)</span>指定的设备为终端时为真
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>3 复杂逻辑判断</p>
<div><pre><code><span>-a</span> 　 　　　　　 与
<span>-o</span>　　　　　　　 或
<span>!</span>　　　　　　　　非
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>4 参数判断</p>
<div><pre><code><span>$0</span> 这个程式的执行名字
<span>$n</span> 这个程式的第n个参数值，n<span>=</span><span>1</span><span>..</span><span>9</span>
<span>$*</span> 这个程式的所有参数,此选项参数可超过9个。
<span>$#</span> 这个程式的参数个数
<span>$$</span> 这个程式的PID<span>(</span>脚本运行的当前进程ID号<span>)</span>
<span>$!</span> 执行上一个背景指令的PID<span>(</span>后台运行的最后一个进程的进程ID号<span>)</span>
<span>$?</span> 执行上一个指令的返回值 <span>(</span>显示最后命令的退出状态。0表示没有错误，其他任何值表明有错误<span>)</span>
$- 显示shell使用的当前选项，与set命令功能相同
<span>$@</span> 跟<span>$*</span>类似，但是可以当作数组
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="判断目录文件数量" tabindex="-1"> 判断目录文件数量</h3>
<p>Linux下有三个命令：<code>ls</code>、<code>grep</code>、<code>wc</code>。通过这三个命令的组合可以统计目录下文件及文件夹的个数。</p>
<p>统计当前目录下文件的个数（不包括目录）</p>
<div><pre><code><span>ls</span> <span>-l</span> <span>|</span> <span>grep</span> <span>"^-"</span> <span>|</span> <span>wc</span> <span>-l</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>统计当前目录下文件的个数（包括子目录）</p>
<div><pre><code><span>ls</span> -lR<span>|</span> <span>grep</span> <span>"^-"</span> <span>|</span> <span>wc</span> <span>-l</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>查看某目录下文件夹(目录)的个数（包括子目录）</p>
<div><pre><code><span>ls</span> <span>-lR</span> <span>|</span> <span>grep</span> <span>"^d"</span> <span>|</span> <span>wc</span> <span>-l</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h3 id="vim" tabindex="-1"> vim</h3>
<p>Vim中如何全选并复制？（区分大小写！！！）</p>
<ol>
<li>全部删除：按esc键后，先按gg（到达顶部），然后dG</li>
<li>全部复制：按esc键后，先按gg，然后ggyG</li>
<li>全选高亮显示：按esc键后，先按gg，然后ggvG或者ggVG</li>
<li>单行复制：按esc键后，然后yy</li>
<li>单行删除：按esc键后，然后dd</li>
<li>粘贴：按esc键后，然后p</li>
</ol>
<p>vim批量注释</p>
<p>1.按下v然后上下键选中内容</p>
<p>2.按下ctrl+v进入列模式，再按下大写I进入插入模式，输入注释符</p>
<p>3.最后按两次esc</p>
<p>vim批量取消注释</p>
<p>1.按ctrl+v，上下键选中后注释符号后按d</p>
<h3 id="ssh" tabindex="-1"> ssh</h3>
<div><pre><code><span>#生成本机密钥</span>
ssh-keygen <span>-t</span> rsa <span>-C</span> <span>"zax"</span>

<span>#发送公钥到指定服务器账户</span>
<span>scp</span> /home/zax/.ssh/id_rsa.pub zax@192.168.2.132:/home/zax/.ssh/authorized_keys

<span>#使用mkpasswd可以根据自己的定义来随意生成密码，其中包括长度，包含内容的个数等。</span>
<span>#首先需要安装expect</span>
yum <span>-y</span> <span>install</span> <span>expect</span>
<span>#安装完成就可以使用了，以下为使用参数（这几个参数基本够用）：</span>
<span>-l</span> <span>#      (密码的长度定义, 默认是 9)</span>
<span>-d</span> <span>#      (数字个数, 默认是 2)</span>
<span>-c</span> <span>#      (小写字符, 默认是 3)</span>
<span>-C</span> <span>#      (大写字符, 默认是 2)</span>
<span>-s</span> <span>#      (特殊字符, 默认是  1)</span>

mkpasswd <span>-l</span> <span>16</span> <span>-d</span> <span>2</span> <span>-C</span> <span>2</span> <span>-s</span> <span>2</span>

<span>#sshd_config配置只允许指定用户+ip登录</span>
AllowUsers zax@192.168.1.63 zax@192.168.1.75

<span>#iptables配置只允许指定ip登录</span>
<span>#禁止所有ip连接22端口</span>
<span>sudo</span> iptables <span>-I</span> INPUT <span>-p</span> tcp <span>--dport</span> <span>22</span> <span>-j</span> DROP
<span>#开启ip段192.168.1.0/24端的80口 可以改成别的端口号</span>
<span>sudo</span> iptables <span>-I</span> INPUT <span>-s</span> <span>192.168</span>.2.0/24 <span>-p</span> tcp <span>--dport</span> <span>22</span> <span>-j</span> ACCEPT
<span>#保存</span>
sservice iptables save

<span>#删除规则</span>
iptables <span>-L</span> INPUT --line-numbers
iptables <span>-D</span> INPUT <span>7</span>

<span>#安装telnet</span>
yum <span>-y</span> <span>install</span> telnet-server.x86_64

<span>#将disable = yes改为 disable = no，退出保存。</span>
<span>nano</span> /etc/xinetd.d/telnet

<span>#然后启动telnet服务：</span>
<span>service</span> xinetd start

<span>#查看启用的加密算法</span>
<span>sudo</span> <span>ssh</span> <span>-Q</span> cipher

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="linux-用-grep-查找单个或多个字符串-关键字" tabindex="-1"> linux 用 grep 查找单个或多个字符串（关键字)</h3>
<p>单个字符串进行查找：</p>
<ol>
<li>
<p>查找当前目录文件名中的字符串：    grep  字符串  文件名</p>
</li>
<li>
<p>查找某个文件中字符串，并输出行号：grep -n 字符串 文件名</p>
</li>
<li>
<p>查找当前目录（包含子目录）的字符串：grep -r 字符串 *</p>
</li>
<li>
<p>查找当前目录（包含子目录）的字符串，并输出行号：grep -rn 字符串 *</p>
</li>
<li>
<ul>
<li>:通配符，表示当前目录所有文件，也可以按照某种模式进行匹配，例如：</li>
</ul>
<p>grep 字符串 *.txt   匹配所有文件后缀名为txt的字符串</p>
</li>
<li>
<p>-r ：递归查找</p>
</li>
<li>
<p>-n ：显示行号</p>
</li>
<li>
<p>-R ：查找所有文件包含子目录</p>
</li>
<li>
<p>-i ：忽略大小写</p>
</li>
<li>
<p>2、同时满足多个字符串查找：</p>
</li>
<li>
<p>grep 字符串1 文件名| grep 字符串2|grep 字符串3|grep ...</p>
</li>
<li>
<p>3、满足多个关键字之一</p>
</li>
<li>
<p>grep -E &quot;字符串1|字符串2|字符串3|&quot;  文件名   或者</p>
</li>
<li>
<p>egrep  &quot;字符串1|字符串2|字符串3|&quot;  文件名</p>
</li>
</ol>
<div><pre><code><span>grep</span> <span>-v</span> <span>"^#"</span> /etc/ssh/sshd_config	<span>#不匹配#开头的行</span>
<span>egrep</span> <span>-v</span> <span>"^#|^$"</span> /etc/ssh/sshd_config
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="查看实时网速" tabindex="-1"> 查看实时网速</h3>
<div><pre><code><span>watch</span> <span>-n</span> <span>1</span> <span>"/sbin/ifconfig eth1 | grep bytes"</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h3 id="磁盘相关命令" tabindex="-1"> 磁盘相关命令</h3>
<div><pre><code><span>#查看磁盘信息</span>
<span>sudo</span> lsblk

<span>sudo</span> <span>fdisk</span> <span>-l</span>

<span>sudo</span> <span>df</span> <span>-h</span>

<span>#查看分区uuid</span>
<span>sudo</span> blkid

<span>#更新磁盘分区表</span>
partx <span>-v</span> <span>-a</span> /dev/sda

<span>#新建分区</span>
<span>fdisk</span> /dev/sda
n
w

<span>#格式化</span>
<span>sudo</span> mkfs.ext4 /dev/sdb1

<span>#开机读取的挂载目录,可以在这里屏蔽有问题的分区</span>
<span>vim</span> /etc/fstab

<span>#安装smartmontools</span>
------------ 在基于 Debian/Ubuntu 的系统上 ------------
<span>sudo</span> <span>apt-get</span> <span>install</span> smartmontools
------------ 在基于 RHEL/CentOS 的系统上 ------------
<span>sudo</span> yum <span>install</span> smartmontools
<span>#检测</span>
<span>sudo</span> smartctl <span>-H</span> /dev/sda

<span># 测试磁盘读写速度</span>
<span># 测试写入速度</span>
<span>sudo</span> <span>dd</span> <span>if</span><span>=</span>/dev/zero <span>of</span><span>=</span>/jobui/tempfile <span>bs</span><span>=</span>1M <span>count</span><span>=</span><span>1024</span>
<span># 测试读取速度</span>
<span>sudo</span> <span>dd</span> <span>if</span><span>=</span>/jobui/tempfile <span>of</span><span>=</span>/dev/null <span>bs</span><span>=</span>1M <span>count</span><span>=</span><span>1024</span>

<span># 查看硬盘型号</span>
hdparm <span>-i</span> /dev/hda
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="创建lvm磁盘" tabindex="-1"> 创建LVM磁盘</h3>
<div><pre><code><span>#将硬盘添加到pv分区</span>
<span>sudo</span> pvcreate /dev/sda
<span>sudo</span> pvcreate /dev/sdb
<span>sudo</span> pvcreate /dev/sdc
<span>sudo</span> pvcreate /dev/sdd
<span>#查看pv分区信息</span>
<span>sudo</span> pvs

<span>#创建并将sda加入VG_SSD1</span>
<span>sudo</span> vgcreate VG_SSD1 /dev/sda
<span>#将sdb加入VG_SSD1</span>
<span>sudo</span> vgextend VG_SSD1 /dev/sdb

<span>#创建并将sdc加入VG_SSD2</span>
<span>sudo</span> vgcreate VG_SSD2 /dev/sdc
<span>#将sdd加入VG_SSD2</span>
<span>sudo</span> vgextend VG_SSD1 /dev/sdd

<span>#查看vg分区信息</span>
<span>sudo</span> vgs
<span>#查看vg详情</span>
<span>sudo</span> vgdisplay VG_SSD1

<span>#创建lv分区</span>
<span>sudo</span> lvcreate <span>--extents</span> <span>100</span>%FREE VG_SSD1 <span>-n</span> LV_SSD1
<span>sudo</span> lvcreate <span>--extents</span> <span>100</span>%FREE VG_SSD2 <span>-n</span> LV_SSD2
<span>#查看lv分区</span>
<span>sudo</span> lvs
<span>#以上步骤创建完了逻辑卷接下来格式化分区</span>
<span>sudo</span> mkfs.ext4 /dev/VG_SSD1/LV_SSD1
<span>sudo</span> mkfs.ext4 /dev/VG_SSD2/LV_SSD2

<span>#挂载分区</span>
<span>mount</span> <span>-o</span> noatime,nodiratime /dev/mapper/VG_SSD1-LV_SSD1 /ssd_jobui
<span>mount</span> <span>-o</span> noatime,nodiratime /dev/mapper/VG_SSD2-LV_SSD2 /ssd_company


lvm vgscan
lvm vgchange <span>-ay</span>
lvm lvs
最后使用e2fsck命令修复一下LVM磁盘：
e2fsck <span>-f</span> <span>-y</span> /dev/mapper/VolGroup00-LogVol00

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content:encoded>
    </item>
    <item>
      <title>tp6笔记</title>
      <link>https://newzone.top/code/tp6.html</link>
      <guid>https://newzone.top/code/tp6.html</guid>
      <source url="https://newzone.top/rss.xml">tp6笔记</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="tp6笔记" tabindex="-1"> tp6笔记</h1>
<h3 id="安装" tabindex="-1"> 安装</h3>
<p>先安装composer</p>
<div><pre><code><span>curl</span> <span>-sS</span> https://getcomposer.org/installer <span>|</span> php
<span>mv</span> composer.phar /usr/local/bin/composer
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>安装项目</p>
<div><pre><code><span>composer</span> create-project topthink/think tp
</code></pre><div aria-hidden="true"><div></div></div></div><p>测试运行</p>
<div><pre><code>php think run
</code></pre><div aria-hidden="true"><div></div></div></div><p>安装扩展</p>
<div><pre><code><span>composer</span> require topthink/think-migration
</code></pre><div aria-hidden="true"><div></div></div></div><p>创建文件</p>
<div><pre><code>php think migrate:create ArticleTable
</code></pre><div aria-hidden="true"><div></div></div></div><p>进入database目录修改代码</p>
<div><pre><code>public <span>function</span> <span>change</span><span>(</span><span>)</span>
<span>{</span>
    // create the table
    <span>$table</span>  <span>=</span>  <span>$this</span>-<span>></span>table<span>(</span><span>'article'</span><span>)</span><span>;</span>
    <span>$table</span>-<span>></span>addColumn<span>(</span><span>'title'</span>, <span>'string'</span>, <span>[</span><span>'comment'</span> <span>=</span><span>></span> <span>'文章标题'</span><span>]</span><span>)</span>
    -<span>></span>addColumn<span>(</span><span>'body'</span>, <span>'text'</span>, <span>[</span><span>'comment'</span> <span>=</span><span>></span> <span>'文章内容'</span><span>]</span><span>)</span>
    -<span>></span>addTimestamps<span>(</span><span>)</span>
    -<span>></span>create<span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>运行建表</p>
<div><pre><code>php think migrate:run
</code></pre><div aria-hidden="true"><div></div></div></div><p>生成控制器、模型</p>
<div><pre><code> php think make:controller index@Demo 
 php think make:model Demo
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>安装包</p>
<div><pre><code>composer install --ignore-platform-reqs
</code></pre><div aria-hidden="true"><div></div></div></div><h4 id="多应用" tabindex="-1"> 多应用</h4>
<p>安装多应用扩展，创建应用目录</p>
<div><pre><code><span>composer</span> require topthink/think-multi-app 
php think build adimn
</code></pre><div aria-hidden="true"><div></div><div></div></div></div>]]></content:encoded>
    </item>
    <item>
      <title>队列</title>
      <link>https://newzone.top/code/%E9%98%9F%E5%88%97.html</link>
      <guid>https://newzone.top/code/%E9%98%9F%E5%88%97.html</guid>
      <source url="https://newzone.top/rss.xml">队列</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="队列" tabindex="-1"> 队列</h1>
<p>curl &quot;http://192.168.2.137:1818/?name=positionCooperationClick&amp;opt=get&quot;  //获取一个队列数据</p>
<p>curl &quot;http://192.168.2.136:1818/?name=test&amp;opt=put&amp;data=test&quot;//存一个队列</p>
<p><img src="@source/images/麻了.jpg" alt="" loading="lazy"></p>
]]></content:encoded>
    </item>
    <item>
      <title>debian10</title>
      <link>https://newzone.top/linux/debian10.html</link>
      <guid>https://newzone.top/linux/debian10.html</guid>
      <source url="https://newzone.top/rss.xml">debian10</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="debian10" tabindex="-1"> debian10</h1>
<h3 id="系统相关命令" tabindex="-1"> 系统相关命令</h3>
<p>编辑网卡配置新增配置</p>
<p>vim /etc/network/interfaces</p>
<div><pre><code><span># This file describes the network interfaces available on your system</span>
<span># and how to activate them. For more information, see interfaces(5).</span>

<span>source</span> /etc/network/interfaces.d/*

<span># The loopback network interface</span>

auto lo
iface lo inet loopback

<span># The primary network interface</span>
allow-hotplug eno1
iface eno1 inet static
        address <span>192.168</span>.100.123/24
        gateway <span>192.168</span>.100.1
        <span># dns-* options are implemented by the resolvconf package, if installed</span>
        dns-nameservers <span>127.0</span>.0.1

auto eno1:1
iface eno1:1 inet static
        address <span>192.168</span>.103.125
        netmask <span>255.255</span>.255.0
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>启动新配置命令</p>
<div><pre><code><span>ifup</span> eno1:1
</code></pre><div aria-hidden="true"><div></div></div></div><div><pre><code><span>#重启网络</span>
/etc/init.d/networking restart
<span>#重启网络(防止配置出错断网)</span>
<span>service</span> networking restart <span>&amp;&amp;</span> <span>ifup</span> enp2s0 
<span>sudo</span> <span>ifup</span> enp3s0:0
<span>sudo</span> <span>ifdown</span> enp3s0:0
<span>#重启ssh</span>
/etc/init.d/ssh restart

<span>#安装sudo</span>
<span>apt-get</span> <span>install</span> <span>sudo</span> <span>-y</span>
<span>#将用户添加到sudo组</span>
<span>usermod</span> <span>-aG</span> <span>sudo</span> z

<span>#新建不允许登录用户</span>
<span>useradd</span> <span>-s</span> /sbin/nologin jobui

<span>#新建普通用户并创建home目录指定bash</span>
<span>useradd</span> <span>-m</span> <span>-s</span> /bin/bash jobui

<span>#debian未指定shell问题</span>
<span>#使用usermod命令修改shell类型</span>
<span>usermod</span> <span>-s</span> /bin/bash zax

<span>#vbox虚拟机设置分辨率</span>
cvt <span>1920</span> <span>1080</span>
xrandr <span>--newmode</span> <span>"1920X1080_60.00"</span> <span>173.00</span>  <span>1920</span> <span>2048</span> <span>2248</span> <span>2576</span>  <span>1080</span> <span>1083</span> <span>1088</span> <span>1120</span> <span>-hsync</span> +vsync
xrandr <span>--addmode</span> Virtual1 <span>"1920X1080_60.00"</span>
xrandr <span>--output</span> Virtual1 <span>--mode</span> <span>"1920X1080_60.00"</span>

<span>#将以上内容添加到/etc/profile文件</span>

<span>#添加ll快捷命令</span>
<span>vi</span> ~/.bashrc

<span>#设置ssh开机启动</span>
update-rc.d <span>ssh</span> <span>enable</span>

<span>#禁止开机启动</span>
update-rc.d <span>ssh</span> disabled

<span>#安装im-config</span>
<span>sudo</span> <span>apt</span> <span>install</span> im-config

<span>#运行im-config，选择fcitx输入法</span>
im-config <span>-c</span>

<span>#解决依赖问题</span>
<span>sudo</span> <span>apt</span> <span>install</span> <span>-f</span>

<span>#查找dep包</span>
<span>sudo</span> dpkg <span>-l</span> sog*

<span>#搜索安装包</span>
<span>sudo</span> <span>apt-cache</span> search openlda

<span>#卸载</span>
<span>sudo</span> dpkg <span>-P</span> sogopinyin

<span>#挂载失败问题（ bad option; for several filesystems (e.g. nfs, cifs) you might need a /sbin/mount.&lt;type> helper program.）</span>
<span>sudo</span> <span>apt</span> <span>install</span> nfs-common
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>配置apt软件源,更新sources.list</p>
<div><pre><code><span>mv</span> /etc/apt/sources.list /etc/apt/sources.list.bak
<span>cat</span> <span>></span> /etc/apt/sources.list <span>&lt;&lt;</span> <span>EOF
deb http://mirrors.cloud.tencent.com/debian/ buster main non-free contrib
deb http://mirrors.cloud.tencent.com/debian-security buster/updates main
deb http://mirrors.cloud.tencent.com/debian/ buster-updates main non-free contrib
deb http://mirrors.cloud.tencent.com/debian/ buster-backports main non-free contrib

deb-src http://mirrors.cloud.tencent.com/debian-security buster/updates main
deb-src http://mirrors.cloud.tencent.com/debian/ buster main non-free contrib
deb-src http://mirrors.cloud.tencent.com/debian/ buster-updates main non-free contrib
deb-src http://mirrors.cloud.tencent.com/debian/ buster-backports main non-free contrib
EOF</span>

<span>apt-get</span> update <span>-y</span>
<span>apt-get</span> <span>install</span> <span>-y</span> <span>vim</span> <span>wget</span>

<span>source</span> ~/.bashrce
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="修改时区为上海" tabindex="-1"> 修改时区为上海</h3>
<div><pre><code><span>cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre><div aria-hidden="true"><div></div></div></div><h3 id="" tabindex="-1"> </h3>
<h3 id="安装iptables-persistent来使用iptables命令" tabindex="-1"> 安装iptables-persistent来使用iptables命令</h3>
<div><pre><code><span>sudo</span> <span>apt</span> <span>install</span> iptables-persistent <span>-y</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h3 id="或者安装使用-ufw-来设置防火墙" tabindex="-1"> 或者安装使用 UFW 来设置防火墙</h3>
<p>安装</p>
<div><pre><code><span>sudo</span> <span>apt</span> update
<span>sudo</span> <span>apt</span> <span>install</span> ufw

<span>#检查状态，默认是关闭</span>
<span>sudo</span> ufw status verbose
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>UFW默认策略是关闭所有进来的连接，开启所有出去的连接，文件路径在：</p>
<blockquote>
<p>/etc/default/ufw</p>
</blockquote>
<p>允许一个端口</p>
<div><pre><code><span>sudo</span> ufw allow <span>7722</span>/tcp
</code></pre><div aria-hidden="true"><div></div></div></div><p>打开一段端口</p>
<div><pre><code><span>sudo</span> ufw allow <span>7100</span>:7200/tcp
<span>sudo</span> ufw allow <span>7100</span>:7200/udp
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>允许指定ip访问所有端口</p>
<div><pre><code><span>sudo</span> ufw allow from <span>10.10</span>.10.10
</code></pre><div aria-hidden="true"><div></div></div></div><p>允许指定ip访问指定端口</p>
<div><pre><code><span>sudo</span> ufw allow from <span>64.63</span>.62.61 to any port <span>22</span>

<span>sudo</span> ufw allow from <span>120.232</span>.65.223 to any port <span>5574,8080</span>,80,9080,443
<span>sudo</span> ufw allow from <span>157.148</span>.45.20 to any port <span>5574,8080</span>,80,9080,443
<span>sudo</span> ufw allow from <span>183.2</span>.143.163 to any port <span>5574,8080</span>,80,9080,443/tcp
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>允许整个网段</p>
<div><pre><code><span>sudo</span> ufw allow from <span>192.168</span>.1.0/24 to any port <span>3306</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>禁止连接</p>
<div><pre><code><span>sudo</span> ufw deny from <span>23.24</span>.25.0/24 to any port <span>80</span>
<span>sudo</span> ufw deny from <span>23.24</span>.25.0/24 to any port <span>443</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>查看规则</p>
<div><pre><code><span>sudo</span> ufw status numbered
</code></pre><div aria-hidden="true"><div></div></div></div><p>删除规则</p>
<div><pre><code><span>sudo</span> ufw delete <span>3</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>启动、关闭、重置</p>
<div><pre><code><span>sudo</span> ufw <span>enable</span>
<span>sudo</span> ufw disable
<span>sudo</span> ufw reset
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h3 id="安装zabbix" tabindex="-1"> 安装zabbix</h3>
<div><pre><code><span>sudo</span> <span>wget</span> https://repo.mysql.com//mysql-apt-config_0.8.17-1_all.deb
<span>sudo</span> dpkg <span>-i</span> mysql-apt-config_0.8.17-1_all.deb
<span>sudo</span> <span>apt</span> update
<span>sudo</span> <span>apt-get</span> <span>install</span> libmysqld-devecho libevent-dev libsnmp-dev libopenipmi-dev

./configure <span>--prefix</span><span>=</span>/web/software/zabbix --enable-server --enable-agent --with-mysql --enable-ipv6 --with-libcurl --with-libxml2 --with-mysql<span>=</span>/usr/bin/mysql_config

<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/zabbix --enable-server --enable-agent --with-mysql --enable-ipv6 --with-net-snmp --with-libcurl --with-libxml2 --with-openipmi --with-mysql<span>=</span>/usr/bin/mysql_config
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>安装zabbix时,出现报错Unsupported charset or collation for tables: ,应该是msyql创建zabbix数据库是,字符编码出现了问题,参考下列方法修复:
1.删除原有的数据库. drop database zabbix;
2.创建新的zabbix数据库,命令:create database zabbix character set utf8 collate utf8_bin;
3.重新打入zabbix的数据库表内容;
mysql -uroot -p123456 zabbix &lt; schema.sql
mysql -uroot -p123456 zabbix &lt; images.sql
mysql -uroot -p123456 zabbix &lt; data.sql
4.然后重新进入zabbix GUI的web 安装界面就OK了</p>
<div><pre><code><span>sudo</span> <span>chown</span> <span>-R</span> jobui:jobui /web/php/local/zabbix/
<span>sudo</span> <span>chmod</span> <span>-R</span> <span>755</span> /web/php/local/zabbix/
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="debian10美化" tabindex="-1"> debian10美化</h3>
<div><pre><code><span>#安装谷歌noto字体</span>
<span>sudo</span> <span>apt</span> <span>install</span> fonts-noto-cjk
<span>#安装依赖</span>
<span>sudo</span> <span>apt</span> <span>install</span> <span>-y</span> gtk2-engines-murrine
<span>#下载Orchis-theme主题</span>
<span>sudo</span> <span>wget</span> https://github.com/vinceliuice/Orchis-theme/archive/refs/heads/master.zip
<span>#下载图标</span>
<span>sudo</span> <span>wget</span>  https://github.com/vinceliuice/Tela-icon-theme/archive/refs/heads/master.zip

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="lnmp环境搭建" tabindex="-1"> lnmp环境搭建</h2>
<h4 id="安装开发环境软件包" tabindex="-1"> 安装开发环境软件包</h4>
<div><pre><code>sudo apt-get install -y build-essential libexpat1-dev libgeoip-dev libpng-dev libpcre3-dev libssl-dev libxml2-dev rcs zlib1g-dev libmcrypt-dev libjpeg-dev libpng-dev libwebp-dev pkg-config libbz2-dev libcurl4-openssl-dev autoconf libmemcached-dev libmemcached11

sudo ln -s /usr/include/x86_64-linux-gnu/curl /usr/local/include/curl
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h5 id="下载软件源码包" tabindex="-1"> 下载软件源码包</h5>
<div><pre><code>cd /usr/local/src
sudo wget https://cdn.mysql.com/archives/mysql-5.6/mysql-5.6.20.tar.gz
sudo wget https://openresty.org/download/openresty-1.9.7.4.tar.gz
sudo wget https://www.php.net/distributions/php-5.6.20.tar.gz


</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h5 id="创建用户nginx、mysql用户" tabindex="-1"> 创建用户nginx、mysql用户</h5>
<div><pre><code>sudo groupadd mysql
sudo useradd -g mysql -d /home/mysql -s /sbin/nologin mysql

sudo groupadd nginx
sudo useradd -g nginx -d /home/nginx -s /sbin/nologin nginx
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h4 id="安装nginx" tabindex="-1"> 安装nginx</h4>
<h5 id="下载安装nginx需要的模块" tabindex="-1"> 下载安装nginx需要的模块</h5>
<div><pre><code>cd /usr/local/src
#zlib库
sudo wget http://www.zlib.net/zlib-1.2.11.tar.gz
sudo tar -zxvf zlib-1.2.11.tar.gz
cd zlib-1.2.11
sudo ./configure --prefix=/web/software/zlib
sudo make
sudo make install

#PCRE库
sudo wget https://ftp.pcre.org/pub/pcre/pcre-8.21.tar.gz
sudo tar -zxvf pcre-8.21.tar.gz
cd pcre-8.21
sudo ./config --prefix=/web/software/pcre
sudo make
sudo make install

#openSSL库
#编译安装openssl报错：POD document had syntax errors at /usr/bin/pod2man line 69. make: *** [install_docs]
#解决方法：
rm -f /usr/bin/pod2man 

sudo wget https://www.openssl.org/source/old/1.0.1/openssl-1.0.1.tar.gz
sudo tar -zxvf openssl-1.0.1.tar.gz
cd openssl-1.0.1
sudo ./config shared --prefix=/usr/local/ssl
sudo make
sudo make install

sudo mv -f /usr/bin/openssl /usr/bin/openssl.old
sudo mv -f /usr/include/openssl /usr/include/openssl.old
sudo ln -s /usr/local/ssl/bin/openssl /usr/bin/openssl
sudo ln -s /usr/local/ssl/include/openssl /usr/include/openssl
sudo ln -s /usr/local/ssl/include/openssl /usr/local/include/openssl

#openSSL库
rm -f /usr/bin/pod2man 
sudo wget https://www.openssl.org/source/old/1.0.1/openssl-1.0.1.tar.gz
sudo tar -zxvf openssl-1.0.1.tar.gz
cd openssl-1.0.1
sudo ./config shared --prefix=/web/software/openssl
sudo make
sudo make install

#libunwind库
sudo wget http://download.savannah.gnu.org/releases/libunwind/libunwind-1.1.tar.gz
sudo tar -zxvf libunwind-1.1.tar.gz
cd libunwind-1.1
sudo CFLAGS=-fPIC ./configure
sudo make CFLAGS=-fPIC
sudo make CFLAGS=-fPIC install

#google-perftools
sudo wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.7/gperftools-2.7.tar.gz
sudo tar -zxvf gperftools-2.7.tar.gz
cd gperftools-2.7
sudo ./configure  --enable-frame-pointers
sudo make
sudo make install
#使google-perftools生效:
sudo echo "/usr/local/lib" >> /etc/ld.so.conf.d/usr_local_lib.conf
sudo ldconfig

#ngx_cache_purge-2.3
sudo wget http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz
sudo tar -zxvf ngx_cache_purge-2.3.tar.gz

#nginx编译参数（线上）
--prefix=/web/software/openresty/nginx \
--with-cc-opt=-O2 \
--add-module=../ngx_devel_kit-0.3.0 \
--add-module=../iconv-nginx-module-0.14 \
--add-module=../echo-nginx-module-0.59 \
--add-module=../xss-nginx-module-0.05 \
--add-module=../ngx_coolkit-0.2rc3 \
--add-module=../set-misc-nginx-module-0.30 \
--add-module=../form-input-nginx-module-0.12 \
--add-module=../encrypted-session-nginx-module-0.05 \
--add-module=../ngx_postgres-1.0rc7 \
--add-module=../srcache-nginx-module-0.31 \
--add-module=../ngx_lua-0.10.5 \
--add-module=../ngx_lua_upstream-0.05 \
--add-module=../headers-more-nginx-module-0.30 \
--add-module=../array-var-nginx-module-0.05 \
--add-module=../memc-nginx-module-0.17 \
--add-module=../redis-nginx-module-0.3.7 \
--add-module=../rds-json-nginx-module-0.14 \
--add-module=../rds-csv-nginx-module-0.07 \
--with-ld-opt=-Wl,-rpath,/web/software/openresty/luajit/lib \
--user=www \
--group=www \
--with-google_perftools_module \
--with-pcre=/root/baicai-V6/web/nginx/pcre-8.36 \
--with-pcre-jit \
--with-zlib=/root/baicai-V6/web/nginx/zlib-1.2.8 \
--add-module=/root/baicai-V6/web/nginx/openresty-1.9.15.1/../ngx_cache_purge-2.3 \
--with-http_stub_status_module \
--with-http_ssl_module
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h5 id="安装openresty-1-9-7-1-包含nginx-1-9-7和插件" tabindex="-1"> 安装openresty-1.9.7.1，包含nginx-1.9.7和插件</h5>
<p>预编译</p>
<div><pre><code>cd /usr/local/src/openresty-1.9.7.4
sudo ./configure \
--prefix=/web/software/openresty \
--user=www \
--group=www \
--with-google_perftools_module \
--with-pcre=../pcre-8.21 \
--with-pcre-jit \
--with-zlib=../zlib-1.2.11 \
--with-openssl=../openssl-1.0.1 \
--add-module=../ngx_cache_purge-2.3 \
--with-http_stub_status_module \
--with-http_ssl_module \
--with-stream
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>编译安装</p>
<div><pre><code>sudo make
sudo make install
#为了统一nginx与其他服务的同步，给nginx目录做软连接
sudo ln -s  /web/software/openresty/nginx  /web/software/nginx
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h4 id="安装php" tabindex="-1"> 安装php</h4>
<div><pre><code><span>#安装m</span>
<span>#zlib</span>
<span>sudo</span> ./configure
<span>sudo</span> <span>make</span>
<span>sudo</span> <span>make</span> <span>install</span>
<span>export</span> <span>LDFLAGS</span><span>=</span><span>"-L/usr/local/zlib/lib"</span>
<span>export</span> <span>CPPFLAGS</span><span>=</span><span>"-I/usr/local/zlib/include"</span>

<span>#jpeg6</span>
<span>#先创建目录，否则会报错</span>
<span>cd</span> /usr/local/src/php/jpeg-6b
<span>sudo</span> <span>mkdir</span> /web/software/jpeg6/
<span>sudo</span> <span>mkdir</span> <span>{</span>/web/software/jpeg6/bin,/web/software/jpeg6/lib,/web/software/jpeg6/include<span>}</span>
<span>sudo</span> <span>mkdir</span> <span>-p</span>  /web/software/jpeg6/man/man1
<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/jpeg6
<span>sudo</span> <span>make</span>
<span>sudo</span> <span>make</span> <span>install</span>

<span>#libpng2</span>
<span>#安装libpng出现configure: error: ZLib not installed</span>
<span>#1.进入zlib的源文件目录，执行命令 make clean,清除zlib；</span>
<span>#2.重新配置 ./configure,后面不要接--prefix参数；</span>
<span>#然后执行以下命令</span>
<span>export</span> <span>LDFLAGS</span><span>=</span><span>"-L/usr/local/zlib/lib"</span>
<span>export</span> <span>CPPFLAGS</span><span>=</span><span>"-I/usr/local/zlib/include"</span>

<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/libpng2
<span>sudo</span> <span>make</span>
<span>sudo</span> <span>make</span> <span>install</span>

<span>#freetype2</span>
<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/freetype2
<span>sudo</span> <span>make</span>
<span>sudo</span> <span>make</span> <span>install</span>

<span>#libxml2</span>
<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/libxml2
<span>sudo</span> <span>make</span>
<span>sudo</span> <span>make</span> <span>install</span>

<span>#curl</span>
<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/curl
<span>sudo</span> <span>make</span>
<span>sudo</span> <span>make</span> <span>install</span>


<span>#php编译参数（线上）</span>
<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/php-5.6.40 <span>\</span>
--with-config-file-path<span>=</span>/web/software/php-5.6.40/lib <span>\</span>
--with-mysql<span>=</span>mysqlnd <span>\</span>
--with-mysqli<span>=</span>mysqlnd <span>\</span>
--with-pdo-mysql<span>=</span>mysqlnd <span>\</span>
--with-jpeg-dir<span>=</span>/web/software/jpeg6 <span>\</span>
--with-png-dir<span>=</span>/web/software/libpng2 <span>\</span>
--with-freetype-dir<span>=</span>/web/software/freetype2 <span>\</span>
--with-libxml-dir<span>=</span>/web/software/libxml2 <span>\</span>
--with-zlib-dir<span>=</span>/usr/local/zlib/ <span>\</span>
--with-curl<span>=</span>/web/software/curl <span>\</span>
--with-openssl<span>=</span>/usr/local/ssl <span>\</span>
--disable-ipv6 <span>\</span>
--enable-sockets <span>\</span>
--disable-debug <span>\</span>
--enable-xml <span>\</span>
--disable-rpath <span>\</span>
--enable-bcmath <span>\</span>
--enable-shmop <span>\</span>
--enable-sysvsem <span>\</span>
--enable-inline-optimization <span>\</span>
--with-curl <span>\</span>
--enable-sysvmsg <span>\</span>
--enable-sysvshm <span>\</span>
--enable-mbregex <span>\</span>
--enable-mbstring <span>\</span>
--with-bz2<span>=</span>/usr <span>\</span>
--enable-gd-native-ttf <span>\</span>
--with-mhash <span>\</span>
--with-xmlrpc <span>\</span>
--enable-zip <span>\</span>
--enable-soap <span>\</span>
--without-pear <span>\</span>
--enable-fpm <span>\</span>
--with-libdir<span>=</span>lib64

<span>#php编译参数（141）</span>
<span>sudo</span> ./configure <span>--prefix</span><span>=</span>/web/software/php-5.6.40 <span>\</span>
--with-config-file-path<span>=</span>/web/software/php-5.6.40/lib <span>\</span>
--with-mysql<span>=</span>mysqlnd <span>\</span>
--with-mysqli<span>=</span>mysqlnd <span>\</span>
--with-pdo-mysql<span>=</span>mysqlnd <span>\</span>
--with-jpeg-dir<span>=</span>/web/software/jpeg6 <span>\</span>
--with-png-dir<span>=</span>/web/software/libpng2 <span>\</span>
--with-freetype-dir<span>=</span>/web/software/freetype2 <span>\</span>
--with-libxml-dir<span>=</span>/web/software/libxml2 <span>\</span>
--with-zlib-dir<span>=</span>/usr/local/zlib/ <span>\</span>
--with-curl<span>=</span>/web/software/curl <span>\</span>
--with-openssl<span>=</span>/usr/local/ssl <span>\</span>
--disable-ipv6 <span>\</span>
--enable-sockets <span>\</span>
--disable-debug <span>\</span>
--enable-xml <span>\</span>
--disable-rpath <span>\</span>
--enable-bcmath <span>\</span>
--enable-shmop <span>\</span>
--enable-sysvsem <span>\</span>
--enable-inline-optimization <span>\</span>
--with-curl <span>\</span>
--enable-sysvmsg <span>\</span>
--enable-sysvshm <span>\</span>
--enable-mbregex <span>\</span>
--enable-mbstring <span>\</span>
--with-bz2<span>=</span>/usr <span>\</span>
--enable-gd-native-ttf <span>\</span>
--with-mhash <span>\</span>
--with-xmlrpc <span>\</span>
--enable-zip <span>\</span>
--enable-soap <span>\</span>
--without-pear <span>\</span>
--enable-fpm <span>\</span>
--enable-pcntl

<span>#编译php时，遇到“Please reinstall the libcurl distribution...”</span>
<span>#sudo apt-get install libcurl4-gnutls-dev</span>
<span>sudo</span> <span>ln</span> <span>-s</span> /usr/include/x86_64-linux-gnu/curl /usr/local/include/curl

<span>#make: *** [Makefile:590：ext/openssl/openssl.lo] 错误 1 (php5.6不兼容openssl1.1.1)</span>
<span>#openssl降级</span>

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="安装deepin版微信" tabindex="-1"> 安装deepin版微信</h3>
<div><pre><code><span>#!/bin/bash</span>
<span>mkdir</span> ./deepintemp
<span>cd</span> ./deepintemp
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine/deepin-wine_2.18-22~rc0_all.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine/deepin-wine32_2.18-22~rc0_i386.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine/deepin-wine32-preloader_2.18-22~rc0_i386.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine-helper/deepin-wine-helper_1.2deepin8_i386.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine-plugin/deepin-wine-plugin_1.0deepin2_amd64.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine-plugin-virtual/deepin-wine-plugin-virtual_1.0deepin3_all.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine-uninstaller/deepin-wine-uninstaller_0.1deepin2_i386.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/u/udis86/udis86_1.72-2_i386.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine/deepin-fonts-wine_2.18-22~rc0_all.deb
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin-wine/deepin-libwine_2.18-22~rc0_i386.deb
<span>wget</span> https://packages.deepin.com/deepin/pool/main/libj/libjpeg-turbo/libjpeg62-turbo_1.5.1-2_amd64.deb --no-check-certificate
<span>wget</span> https://packages.deepin.com/deepin/pool/main/libj/libjpeg-turbo/libjpeg62-turbo_1.5.1-2_i386.deb --no-check-certificate
<span>wget</span> http://packages.deepin.com/deepin/pool/non-free/d/deepin.com.wechat/deepin.com.wechat_2.6.8.65deepin0_i386.deb

<span>echo</span> <span>'准备添加32位支持'</span>
dpkg --add-architecture i386
<span>echo</span> <span>'添加成功，准备刷新apt缓存信息...'</span>
<span>apt</span> update
<span>echo</span> <span>'即将开始安装...'</span>
dpkg <span>-i</span> *.deb
<span>echo</span> <span>'安装完成，正在自动安装依赖...'</span>
<span>apt</span> <span>install</span> <span>-fy</span>
dpkg <span>-i</span> deepin.com.wechat_2.6.8.65deepin0_i386.deb
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>中文问题，进入/opt/deepinwine/tools文件夹</p>
<p>在run.sh 和 run_v2.sh 中修改为</p>
<div><pre><code><span>#WINE_CMD="deepin-wine"改为下行</span>
<span>WINE_CMD</span><span>=</span><span>"LC_ALL=zh_CN.UTF-8 deepin-wine"</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="安装navicat" tabindex="-1"> 安装navicat</h3>
<div><pre><code><span>wget</span> https://download3.navicat.com/download/navicat15-premium-en.AppImage --no-check-certificate
<span>chmod</span> +x navicat15-premium-en.AppImage
./navicat15-premium-en.AppImage
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div>]]></content:encoded>
    </item>
    <item>
      <title>debian10编译安装php7.4</title>
      <link>https://newzone.top/linux/debian10%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85php7.4.html</link>
      <guid>https://newzone.top/linux/debian10%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85php7.4.html</guid>
      <source url="https://newzone.top/rss.xml">debian10编译安装php7.4</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="debian10编译安装php7-4" tabindex="-1"> debian10编译安装php7.4</h1>
<div><pre><code><span>##/bin/bash</span>

<span>apt-get</span> <span>install</span> <span>-y</span> libsqlite3-dev libmemcached-dev libmagickwand-dev libmagickcore-dev <span>\</span>
libdatrie-dev libmcrypt-dev procps libonig-dev libzip-dev

<span>#apt-get install -y build-essential libexpat1-dev libgeoip-dev libpng-dev libpcre3-dev libssl-dev libxml2-dev rcs zlib1g-dev libmcrypt-dev libjpeg-dev libpng-dev libwebp-dev pkg-config libbz2-dev libcurl4-openssl-dev autoconf libmemcached-dev libmemcached11</span>

<span>cd</span> /usr/local/src/package/php-7.4.24/ <span>&amp;&amp;</span> <span>\</span>
	./configure <span>\</span>
    <span>--prefix</span><span>=</span>/web/software/php-7.4.24 <span>\</span>
    --with-config-file-path<span>=</span>/web/software/php-7.4.24/lib <span>\</span>
    --with-mysqli<span>=</span>mysqlnd <span>\</span>
    --with-pdo-mysql<span>=</span>mysqlnd <span>\</span>
    --with-zlib <span>\</span>
    --disable-ipv6 <span>\</span>
    --enable-sockets <span>\</span>
    --disable-debug <span>\</span>
    --enable-xml <span>\</span>
    --disable-rpath <span>\</span>
    --enable-bcmath <span>\</span>
    --enable-shmop <span>\</span>
    --enable-sysvsem <span>\</span>
    --enable-inline-optimization <span>\</span>
    --enable-sysvmsg <span>\</span>
    --enable-sysvshm <span>\</span>
    --enable-mbregex <span>\</span>
    --enable-mbstring <span>\</span>
    --with-bz2 <span>\</span>
    --with-libxml <span>\</span>
    --with-curl <span>\</span>
    --with-openssl <span>\</span>
    --with-mhash <span>\</span>
    --with-xmlrpc <span>\</span>
    --with-zip <span>\</span>
    --enable-soap <span>\</span>
    --without-pear <span>\</span>
    --enable-fpm <span>&amp;&amp;</span> <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span>

<span># apcu</span>
    <span>cd</span> /usr/local/src/package/apcu-5.1.19 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># blitz</span>
    <span>cd</span> /usr/local/src/package/blitz-0.10.4-PHP7/ <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># memcached</span>
    <span>cd</span> /usr/local/src/package/memcached-3.1.5 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># memcache</span>
    <span>cd</span> /usr/local/src/package/memcache-8.0 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># mongodb</span>
    <span>cd</span> /usr/local/src/package/mongodb-1.10.0 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># igbinary</span>
    <span>cd</span> /usr/local/src/package/igbinary-3.2.6 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># redis</span>
    <span>cd</span> /usr/local/src/package/redis-4.3.0 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># imagick</span>
    <span>cd</span> /usr/local/src/package/imagick-3.5.1 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># qqwry</span>
	<span>cd</span> /usr/local/src/package <span>\</span>
    <span>cd</span> /usr/local/src/package/qqwry-master/php/qqwry/ <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># xhprof</span>
    <span>cd</span> /usr/local/src/package/xhprof-2.3.4/extension/ <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># php-ext-trie-filter</span>
    <span>cd</span> /usr/local/src/package/php-ext-trie-filter-php7 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># scws</span>
    <span>cd</span> /usr/local/src/package/scws-1.2.3/ <span>\</span>
    ./configure <span>--prefix</span><span>=</span>/web/software/scws-1.2.3/ <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
    <span>cp</span> <span>-r</span> /usr/local/src/package/dict* /web/software/scws-1.2.3/etc/ <span>\</span>
<span># scws-phpext</span>
    <span>cd</span> /usr/local/src/package/scws-1.2.3/phpext <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure --with-scws<span>=</span>/web/software/scws-1.2.3 --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># mcrypt</span>
    <span>cd</span> /usr/local/src/package/mcrypt-1.0.4 <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    aclocal <span>\</span>
    ./configure --with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>
<span># gd</span>
    <span>cd</span> /usr/local/src/package/php-7.4.24/ext/gd <span>\</span>
    /web/software/php-7.4.24/bin/phpize <span>\</span>
    ./configure -with-php-config<span>=</span>/web/software/php-7.4.24/bin/php-config --enable-gd --with-jpeg --with-freetype <span>\</span>
    <span>make</span> <span>&amp;&amp;</span> <span>make</span> <span>install</span> <span>\</span>

<span>cp</span> /usr/local/src/docker/php/php-fpm.conf /web/software/php-7.4.24/etc/php-fpm.conf

<span>cp</span> /usr/local/src/docker/php/php-fpm /etc/init.d/php-fpm

<span>chmod</span> <span>755</span> /etc/init.d/php-fpm

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content:encoded>
    </item>
    <item>
      <title>iptables</title>
      <link>https://newzone.top/linux/iptables.html</link>
      <guid>https://newzone.top/linux/iptables.html</guid>
      <source url="https://newzone.top/rss.xml">iptables</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="iptables" tabindex="-1"> iptables</h1>
<div><pre><code><span>#1.开启一个ssh端口</span>

<span>vi</span> /etc/ssh/sshd_config

<span>#把#Port 22</span>
<span>#修改为</span>

Port <span>22</span>
Port <span>2222</span>

<span>service</span> sshd restart

<span>#防火墙开启2222端口（如果开启了selinux，记得一定要关闭）</span>

<span>#去测试一下2222端口是否开启，这点很重要</span>

<span>#2.设置方法一：只允许192.168.5.231访问</span>

<span>#运行完下面这一行，你已经不能访问了，改用2222去设置下面一行</span>
iptables <span>-I</span> INPUT <span>-p</span> tcp <span>--dport</span> <span>22</span> <span>-j</span> DROP

<span>#用2222端口去运行下面一行，运行完，22端口就可以使用</span>
iptables <span>-I</span> INPUT <span>-s</span> x.x.x.x <span>-p</span> tcp <span>--dport</span> <span>22</span> <span>-j</span> ACCEPT

<span>#保存</span>
<span>service</span> iptables save

<span>#重启</span>
<span>service</span> iptables restart
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code>#!/bin/sh

# 先备份iptables规则
mkdir /web/shell/iptables_bak
cp /etc/sysconfig/iptables /web/shell/iptables_bak/iptables

# 设置之前关闭防火墙才是最安全的办法，否则会发生连接不上的问题
service iptables stop

# 禁止所有ip访问60011端口
iptables -I INPUT -p tcp --dport 60011 -j DROP

# 开放指定ip可以连接60011端口
iptables -A INPUT -i 127.0.0.1 -p tcp --dport 60011 -j ACCEPT
iptables -I INPUT -s x.x.x.x,192.168.2.0/24 -p tcp --dport 60011 -j ACCEPT

# 允许部分出去的网络  			
iptables -A OUTPUT -d 192.168.2.0/24,x.x.x.x,121.201.88.88,114.114.114.114 -j ACCEPT    
   
# 允许访问的外网
iptables -A OUTPUT -d open.work.weixin.qq.com,v0.api.upyun.com,v1.api.upyun.com,v2.api.upyun.com,v3.api.upyun.com,graph.qq.com,apis.map.qq.com,api.weixin.qq.com,login.weixin.qq.com,wx.qq.com,api.weibo.com,js4.jobui.com,css4.jobui.com,m.jobui.com,www.jobui.com,apis.jobui.com -j ACCEPT


#允许icmp包通过,也就是允许ping
iptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT

#本机对外请求相当于OUTPUT,对于返回数据包必须接收啊，这相当于INPUT了
iptables -I INPUT -i lo -j ACCEPT
iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

# 禁用所有出去的网络
iptables -P OUTPUT DROP

# 保存iptbales规则
service iptables save

# 重新启动
service iptables restart 


</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span># 查看所有规则列表并打印编号</span>
iptables <span>-L</span> <span>-n</span> --line-numbers

<span># 删除一条规则</span>
iptables <span>-D</span> INPUT <span>7</span>
<span># 或</span>
iptables <span>-D</span> OUTPUT <span>7</span>

<span># 允许所有出口访问</span>
<span>sudo</span> iptables <span>-A</span> OUTPUT <span>-j</span> ACCEPT

<span>#允许所有入口访问</span>
<span>sudo</span> iptables <span>-A</span> INPUT <span>-j</span> ACCEPT
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>#!/bin/sh</span>

<span># 先备份iptables规则</span>
<span>mkdir</span> /web/shell/iptables_bak
<span>cp</span> /etc/sysconfig/iptables /web/shell/iptables_bak/iptables

<span>sed</span> <span>-i</span> <span>"s|#Port 22|Port 60011|g"</span> /etc/ssh/sshd_config

<span># 设置之前关闭防火墙才是最安全的办法，否则会发生连接不上的问题</span>
<span>#service iptables stop</span>

<span># 禁止所有ip访问60011端口</span>
iptables <span>-I</span> INPUT <span>-p</span> tcp <span>--dport</span> <span>60011</span> <span>-j</span> DROP

<span># 开放指定ip可以连接60011端口</span>
iptables <span>-A</span> INPUT <span>-i</span> <span>127.0</span>.0.1 <span>-p</span> tcp <span>--dport</span> <span>60011</span> <span>-j</span> ACCEPT
iptables <span>-I</span> INPUT <span>-s</span> x.x.x.x,192.168.2.0/24 <span>-p</span> tcp <span>--dport</span> <span>60011</span> <span>-j</span> ACCEPT

<span>service</span> iptables save
<span>service</span> sshd restart
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>debian管理iptables需要用到iptables-persistent</p>
<p>通过iptables-persistent生成的规则默认将被存储在以下文件中</p>
<p>/etc/iptables/rules.v4    /etc/iptables/rules.v6</p>
</blockquote>
<div><pre><code><span>apt</span> <span>install</span> iptables-persistent <span>-y</span>

<span># 保存重载</span>
 <span>sudo</span> netfilter-persistent save
 <span>sudo</span> netfilter-persistent reload
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>iptables -A INPUT -i x.x.x.x -p tcp --dport 80 -j ACCEPT</p>
<p>iptables -A INPUT -i x.x.x.x -p tcp --dport 443 -j ACCEPT</p>
<h3 id="服务器处理" tabindex="-1"> 服务器处理</h3>
<ol>
<li>限制登陆ip只有x.x.x.x才能登陆</li>
<li>防火墙限制访问外网ip</li>
<li>修改默认ssh端口为60011</li>
<li>修改全部账号密码，root、jobui及个人账号，删除可疑账号</li>
</ol>
]]></content:encoded>
    </item>
    <item>
      <title>ElasticSearch</title>
      <link>https://newzone.top/services/ElasticSearch.html</link>
      <guid>https://newzone.top/services/ElasticSearch.html</guid>
      <source url="https://newzone.top/rss.xml">ElasticSearch</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="elasticsearch" tabindex="-1"> ElasticSearch</h1>
<p>搜索</p>
<div><pre><code>GET _search
{
  "query": {
    "match": {
      "_index" : "jobui_interview_v1"
    }
  },
  "size" : 100
}
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>查看所有索引</p>
<div><pre><code>GET /_cat/indices?v	
GET _cat/indices?v&amp;s=store.size:desc//按大小倒叙
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>新建索引映射</p>
<div><pre><code> PUT /jobui_interview_v1/external/1?pretty
{
  "name": "John Doe"
}

GET /jobui_company_album/_mapping?pretty

PUT jobui_interview_v1
{
	"mappings":{
		"interview":{
			"_all": {
				"enabled": false
			},
			"properties":{
				"CIE_ID": {
					"type": "integer"
				},
				"CIE_CompanyID": {
					"type": "integer"
				},
				"CIE_PositionID": {
					"type": "integer"
				},
				"CIE_PositionName": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_CompanyName": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_UserKey": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_UserIP": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_UsefulNum": {
					"type": "integer"
				},
				"CIE_NotUsefulNum": {
					"type": "integer"
				},
				"CIE_IsNick": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_CheckStatus": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_Content": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_ClientType": {
					"type": "text",
					"analyzer": "ik_smart",
					"include_in_all": true
				},
				"CIE_AddTime": {
					"type": "long"
				},
				"CIE_LastCheckTime": {
					"type": "long"
				},
				"CIE_LastUpdateTime": {
					"type": "long"
				},
				"lt": {
					"type": "long"
				}
			}
		}
	},
	"settings": {
		"number_of_shards" :   1,
		"number_of_replicas" : 1
	}
}
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>设置别名</p>
<div><pre><code>PUT /jobui_interview_v1/_alias/jobui_interview
</code></pre><div aria-hidden="true"><div></div></div></div><p>设置别名
PUT /jobui_interview_v1/_alias/jobui_interview</p>
<p>差看映射信息</p>
<div><pre><code>GET /jobui_interview_v1/_mapping?pretty
</code></pre><div aria-hidden="true"><div></div></div></div><p>#查看索引内容</p>
<div><pre><code>GET jobui_interview_v1
</code></pre><div aria-hidden="true"><div></div></div></div><p>删除索引</p>
<div><pre><code>DELETE jobui_interview_v1
</code></pre><div aria-hidden="true"><div></div></div></div><p>查看单个文档</p>
<div><pre><code>GET jobui_company_job_v1/job/9650100?pretty
</code></pre><div aria-hidden="true"><div></div></div></div><p>查询内容</p>
<div><pre><code>POST /jobui_company_job_v1/_search?pretty
{

  "query": { "match": { "SPI_CompanyCity": "上海" } }

}
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>查看集群</p>
<div><pre><code>GET _cluster/health?pretty
</code></pre><div aria-hidden="true"><div></div></div></div><div><pre><code><span>#查看数据（shell）</span>

<span>#查看所有索引（按大小倒序）</span>
<span>curl</span> <span>-XGET</span> <span>'http://192.168.2.135:9200/_cat/indices?v&amp;s=store.size:desc'</span>

<span>#删除索引</span>
<span>curl</span> <span>-XDELETE</span> <span>'http://192.168.2.135:9200/nginx_apis-access-2021.08.31?pretty'</span>

<span>#查看索引mapping</span>
<span>curl</span> <span>"192.168.1.74:9200/索引名称/_mapping"</span>

<span>#查看单个文档</span>
<span>curl</span> <span>-XGET</span> <span>'localhost:9200/索引名称/类型/ID?pretty'</span>

<span>#创建文档</span>
<span>curl</span> <span>-XPUT</span> <span>'localhost:9200/customer/external/1?pretty'</span> <span>-d</span> <span>'
{
  "name": "John Doe"
}'</span>

<span>#查询文档内容</span>
<span>curl</span> <span>-XPOST</span> <span>'localhost:9200/bank/_search?pretty'</span> <span>-d</span> <span>'
{
  "query": { "match": { "address": "mill" } }
}'</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="es-kibana部署" tabindex="-1"> es+kibana部署</h2>
<p><strong>基础环境：jdk8</strong></p>
<h4 id="安装jdk" tabindex="-1"> 安装jdk</h4>
<p>下载jdk包</p>
<div><pre><code><span>mkdir</span> <span>-p</span> /usr/local/java 
<span>cd</span> /usr/local/java 
<span>wget</span> https://download.oracle.com/otn/java/jdk/8u321-b07/df5ad55fdd604472a86a45a217032c7d/jdk-8u321-linux-x64.tar.gz?AuthParam<span>=</span>1647915953_6b486a8019a80931d2b2bdca8b505d6a
<span>tar</span> zxvf jdk-8u321-linux-x64.tar.gz <span>-C</span> /usr/local/java
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h4 id="配置jdk环境变量" tabindex="-1"> 配置jdk环境变量</h4>
<div><pre><code><span>vim</span> /etc/profile
<span>#添加</span>
<span>JAVA_HOME</span><span>=</span>/usr/local/java/jdk1.8.0_311/
<span>export</span> <span>CLASSPATH</span><span>=</span>$:CLASSPATH:<span>$JAVA_HOME</span>/lib/ 
<span>export</span> <span><span>PATH</span></span><span>=</span><span>$PATH</span><span>:</span><span>$JAVA_HOME</span>/bin 

<span>#加载文件生效</span>
<span>source</span> /etc/profile
<span>#查看版本</span>
<span>java</span> <span>-version</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h4 id="安装elasticsearch5-6" tabindex="-1"> 安装elasticsearch5.6</h4>
<div><pre><code><span>wget</span> https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.16.tar.gz
sha1sum elasticsearch-5.6.16.tar.gz 
<span>tar</span> <span>-xzf</span> elasticsearch-5.6.16.tar.gz

<span>#后台启动并记录pid</span>
<span>cd</span> elasticsearch-5.6.16/ 
./bin/elasticsearch <span>-p</span> /mysql/elasticsearch/elasticsearch-pid <span>-d</span>

<span>#连接测试</span>
<span>curl</span> <span>-XGET</span> <span>192.168</span>.1.36:9200

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h4 id="安装kibana5-6" tabindex="-1"> 安装kibana5.6</h4>
<div><pre><code><span>wget</span> https://artifacts.elastic.co/downloads/kibana/kibana-5.6.16-linux-x86_64.tar.gz
sha1sum kibana-5.6.16-linux-x86_64.tar.gz 
<span>tar</span> <span>-xzf</span> kibana-5.6.16-linux-x86_64.tar.gz
<span>cd</span> kibana-5.6.16-linux-x86_64/ 

<span>#后台启动</span>
./bin/kibana <span>>></span> /mysql/elasticsearch/kibana.stdout <span><span>2</span>>></span> /mysql/elasticsearch/kibana.stderr <span>&amp;</span>

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content:encoded>
    </item>
    <item>
      <title>Docker环境启动</title>
      <link>https://newzone.top/services/jobui_docker%E7%8E%AF%E5%A2%83.html</link>
      <guid>https://newzone.top/services/jobui_docker%E7%8E%AF%E5%A2%83.html</guid>
      <source url="https://newzone.top/rss.xml">Docker环境启动</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="docker环境启动" tabindex="-1"> Docker环境启动</h1>
<p>安装docker for windows</p>
<p>将docker-compose.yml文件跟docker文件夹解压到项目根目录下</p>
<p>拉取镜像</p>
<div><pre><code><span>docker</span> pull doflamingozzz/nginx-1.15.8.3:1.0
<span>docker</span> pull doflamingozzz/php7.4:1.0
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>启动环境</p>
<div><pre><code><span>docker-compose</span> up <span>-d</span>
</code></pre><div aria-hidden="true"><div></div></div></div>]]></content:encoded>
    </item>
    <item>
      <title>mongo</title>
      <link>https://newzone.top/services/mongo.html</link>
      <guid>https://newzone.top/services/mongo.html</guid>
      <source url="https://newzone.top/rss.xml">mongo</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="mongo" tabindex="-1"> mongo</h1>
<h3 id="服务配置" tabindex="-1"> 服务配置</h3>
<h4 id="配置复制集" tabindex="-1"> 配置复制集</h4>
<div><pre><code><span># 连接</span>
mongo <span>192.168</span>.2.134:12000
<span># 初始化（第一次配置）</span>
<span>></span>rs.initiate<span>(</span><span>)</span>
<span>></span>rs.add<span>(</span><span>"hostname:120000"</span><span>)</span>

<span># 查看状态</span>
<span>></span>rs.status<span>(</span><span>)</span>

<span>></span>rs.add<span>(</span><span>{</span>host:<span>'hostname:12000'</span><span>}</span><span>)</span><span>(</span>添加一个复制集<span>)</span>
<span>></span>rs.addArb<span>(</span><span>"hostnamet:30000"</span><span>)</span><span>(</span>添加一个投票节点<span>)</span>
<span>></span>rs.remove<span>(</span><span>"hostname:30000"</span><span>)</span><span>(</span>删除节点<span>)</span>


/web/software/mongodb-3.0.7/bin/mongod <span>-f</span> /web/bcshell/mongodb/mongodbWT12000.conf <span>--rest</span> <span>--logpath</span><span>=</span>/tmp/mongod.log<span>(</span>输出日志<span>)</span>

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h4 id="修改优先级" tabindex="-1"> 修改优先级</h4>
<p>通过改动priority的值来实现（默认的优先级是1（0-100）。priority的值设的越大，就优先成为主）</p>
<div><pre><code>PRIMARY<span>></span> <span>config</span><span>=</span>rs.conf<span>(</span><span>)</span>
PRIMARY<span>></span> config.members<span>[</span><span>0</span><span>]</span>.priority <span>=</span> <span>2</span>       这里要注意：0表示第一个节点，1表示第二个节点，以此类推
PRIMARY<span>></span> rs.reconfig<span>(</span>config<span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h4 id="启动命令" tabindex="-1"> 启动命令</h4>
<div><pre><code>/web/software/mongodb-3.0.7/bin/mongod <span>-f</span> /web/bcshell/mongodb/mongodbWT12002.conf <span>--rest</span> <span>--logpath</span><span>=</span>/tmp/mongod2.log
/web/software/mongodb-3.0.7/bin/mongod <span>-f</span> /web/bcshell/mongodb/mongodbWT12000.conf <span>--rest</span> <span>--logpath</span><span>=</span>/tmp/mongod.log
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="关闭命令" tabindex="-1"> 关闭命令</h3>
<div><pre><code>db.shutdownServer<span>(</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h4 id="创建用户" tabindex="-1"> 创建用户</h4>
<div><pre><code><span>#进去mongo后切换到admin库</span>
use admin
<span>#创建管理员用户</span>
db.createUser<span>(</span><span>{</span>user:<span>"root"</span>,pwd:<span>"root123"</span>,roles:<span>[</span><span>"root"</span><span>]</span><span>}</span><span>)</span>
db.createUser<span>(</span><span>{</span>user:<span>"zax"</span>,pwd:<span>"root123"</span>,roles:<span>[</span><span>"root"</span><span>]</span><span>}</span><span>)</span>
<span>#查看用户</span>
show <span>users</span>
<span>#删除用户</span>
db.dropUser<span>(</span><span>"zax"</span><span>)</span>
<span>#修改密码</span>
db.updateUser<span>(</span><span>"zax"</span>,<span>{</span>pwd:<span>"123"</span><span>}</span><span>)</span>

<span>#创建普通用户，并指定权限</span>
db.createUser<span>(</span><span>{</span>
	user:<span>"jobui"</span>,pwd:<span>"jobui123"</span>,
	roles:<span>[</span>
		<span>{</span>role:<span>"readWrite"</span>,db:<span>"tmp"</span><span>}</span>,
		<span>{</span>role:<span>"read"</span>,db:<span>"tmp2"</span><span>}</span>
	<span>]</span>
	<span>}</span><span>)</span>
<span>#创建一个有所有库权限的用户</span>
db.createUser<span>(</span><span>{</span>
	user:<span>"jobui_w"</span>,pwd:<span>"jobui123"</span>,
	roles:<span>[</span>
		<span>{</span>role:<span>"readWriteAnyDatabase"</span>,db:<span>"admin"</span><span>}</span>
	<span>]</span>
<span>}</span><span>)</span>
<span>#修改权限</span>
db.grantRolesToUser<span>(</span><span>"jobui_w"</span>, <span>[</span><span>{</span>role:<span>"clusterAdmin"</span>, db:<span>"admin"</span><span>}</span>,<span>]</span><span>)</span>

db.createUser<span>(</span> <span>{</span> 
    user: <span>"cluster"</span>, 
    pwd: <span>"cluster"</span>, 
    roles: <span>[</span> <span>{</span> role: <span>"clusterAdmin"</span>, db: <span>"admin"</span> <span>}</span> <span>]</span> 
<span>}</span><span>)</span><span>;</span> 

<span>#生成密钥</span>
openssl rand <span>-base64</span> <span>100</span> <span>></span>/web/shell/mongodb/mongo-keyfile
<span>chmod</span> <span>400</span> mongo-keyfile

mongod <span>-f</span> /web/shell/mongodb/mongodbWT12002.conf <span>--keyFile</span><span>=</span>/web/shell/mongodb/mongo-keyfile
mongod <span>-f</span> /web/shell/mongodb/mongodbWT12003.conf <span>--keyFile</span><span>=</span>/web/shell/mongodb/mongo-keyfile
mongod <span>-f</span> /web/shell/mongodb/mongodbWT12004.conf <span>--keyFile</span><span>=</span>/web/shell/mongodb/mongo-keyfile

mongod <span>-f</span> /web/shell/mongodb/mongodbWT12002.conf
mongod <span>-f</span> /web/shell/mongodb/mongodbWT12003.conf
mongod <span>-f</span> /web/shell/mongodb/mongodbWT12004.conf

Read：允许用户读取指定数据库
readWrite：允许用户读写指定数据库
dbAdmin：允许用户在指定数据库中执行管理函数，如索引创建、删除，查看统计或访问system.profile
userAdmin：允许用户向system.users集合写入，可以找指定数据库里创建、删除和管理用户
clusterAdmin：只在admin数据库中可用，赋予用户所有分片和复制集相关函数的管理权限。
readAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读权限
readWriteAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的读写权限
userAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的userAdmin权限
dbAdminAnyDatabase：只在admin数据库中可用，赋予用户所有数据库的dbAdmin权限。
root：只在admin数据库中可用。超级账号，超级权限

<span># 验证密码</span>
<span>></span>use admin<span>;</span>
<span>></span>db.auth<span>(</span><span>"username"</span>, <span>"passwd"</span><span>)</span>

<span># 登录直接验证密码</span>
mongo <span>192.168</span>.1.36:27017 <span>-u</span> <span>"jobui_w"</span> <span>-p</span> <span>"j"</span> <span>--authenticationDatabase</span> <span>"admin"</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code>db.createCollection<span>(</span><span>"JobProfessionID"</span><span>)</span>
show tables

<span>#创建数据库</span>
<span><span>`</span>use DATABASE_NAME<span>`</span></span>

<span>#切换到数据库</span>
<span><span>`</span>use <span>test</span><span>`</span></span>

<span>#创建集合</span>
<span><span>`</span>db.createCollection<span>(</span><span>"runoob"</span><span>)</span><span>`</span></span>

<span>#查看集合</span>
<span><span>`</span>show collections<span>`</span></span>

<span>#删除集合</span>
<span><span>`</span>db.集合名称.drop<span>(</span><span>)</span><span>`</span></span>

<span>#查看集合条数</span>
db.getCollection<span>(</span><span>'userTmp'</span><span>)</span>.find<span>(</span><span>{</span><span>}</span><span>)</span>.count<span>(</span><span>)</span>


</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code>db.createCollection<span>(</span><span>"userTmp_202110"</span><span>)</span>
db.getCollection<span>(</span><span>'companyTmp_202110'</span><span>)</span>.createIndex<span>(</span><span>{</span><span>'c'</span><span>:</span> <span>1</span>, <span>'d'</span><span>:</span> -1<span>}</span>, <span>{</span>unique: true<span>}</span><span>)</span>
db.getCollection<span>(</span><span>'userTmp_202110'</span><span>)</span>.createIndex<span>(</span><span>{</span><span>'u'</span><span>:</span> <span>1</span>, <span>'d'</span><span>:</span> -1<span>}</span>, <span>{</span>unique: true<span>}</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h3 id="导出数据库" tabindex="-1"> 导出数据库</h3>
<div><pre><code>mongodump <span>-h</span> <span>192.168</span>.1.35:12000 <span>-d</span> jobui_tmp <span>-o</span> /ssd_data/mongobackups/
</code></pre><div aria-hidden="true"><div></div></div></div><h3 id="导入数据" tabindex="-1"> 导入数据</h3>
<div><pre><code>
</code></pre><div aria-hidden="true"><div></div></div></div><h3 id="创建索引" tabindex="-1"> 创建索引</h3>
<div><pre><code><span>#语法中 Key 值为你要创建的索引字段，1 为指定按升序创建索引，如果你想按降序来创建索引指定为 -1 即可。</span>
<span>></span>db.collection.createIndex<span>(</span>keys, options<span>)</span>

<span>#在后台创建复合索引</span>
db.values.createIndex<span>(</span><span>{</span>open: <span>1</span>, close: <span>1</span><span>}</span>, <span>{</span>background: true<span>}</span><span>)</span>
db.col.createIndex<span>(</span><span>{</span><span>'c'</span><span>:</span> <span>1</span>, <span>'d'</span><span>:</span> -1<span>}</span>, <span>{</span>unique: true<span>}</span><span>)</span>

<span>#创建单条索引</span>
db.getCollection<span>(</span><span>'userTmp_202109'</span><span>)</span>.createIndex<span>(</span><span>{</span><span>'lut'</span>:-1<span>}</span><span>)</span>

<span>#1、查看集合索引</span>
db.getCollection<span>(</span><span>'userFollowCompany'</span><span>)</span>.getIndexes<span>(</span><span>)</span>

<span>#2、查看集合索引大小</span>
db.getCollection<span>(</span><span>'userFollowCompany'</span><span>)</span>.totalIndexSize<span>(</span><span>)</span>

<span>#3、删除集合所有索引</span>
db.col.dropIndexes<span>(</span><span>)</span>

<span>#4、删除集合指定索引</span>
db.col.dropIndex<span>(</span><span>"索引名称"</span><span>)</span>

<span>#查看索引建立状态</span>
db.currentOp<span>(</span><span>)</span>

<span>#终止索引的创建</span>
db.killOp<span>(</span><span>)</span>

<span>#高级聚类</span>
db.getCollection<span>(</span><span>'userFollowCompany'</span><span>)</span>.aggregate<span>(</span><span>[</span>
	<span>{</span><span>$match</span>:<span>{</span>cid:<span>{</span><span>$in</span><span>:</span> <span>[</span><span>788679</span><span>]</span><span>}</span><span>}</span><span>}</span>,
	<span>{</span><span>$unwind</span><span>:</span><span>"<span>$cid</span>"</span><span>}</span>,
	<span>{</span><span>$match</span>:<span>{</span>cid:<span>{</span><span>$ne</span>:788679<span>}</span><span>}</span><span>}</span>,
	<span>{</span><span>$group</span>:<span>{</span>_id:<span>"<span>$cid</span>"</span>,num:<span>{</span><span>$sum</span>:1<span>}</span><span>}</span><span>}</span>,
	<span>{</span><span>$sort</span>:<span>{</span>num:-1<span>}</span><span>}</span>,
	<span>{</span><span>$limit</span>:100<span>}</span>
<span>]</span><span>)</span>

db.getCollection<span>(</span><span>'userFollowCompany'</span><span>)</span>.aggregate<span>(</span><span>[</span>
    <span>{</span><span>$match</span>:<span>{</span><span>'mint'</span><span>:</span> <span>{</span><span>$gt</span>:20220401<span>}</span>, cid:<span>{</span><span>$in</span><span>:</span> <span>[</span><span>15110</span><span>]</span><span>}</span><span>}</span><span>}</span>,
    <span>{</span><span>$unwind</span><span>:</span><span>"<span>$cid</span>"</span><span>}</span>,
    <span>{</span><span>$group</span>:<span>{</span>_id:<span>"<span>$cid</span>"</span>,num:<span>{</span><span>$sum</span>:1<span>}</span><span>}</span><span>}</span>,
    <span>{</span><span>$sort</span>:<span>{</span>num:-1<span>}</span><span>}</span>,
    <span>{</span><span>$limit</span>:100<span>}</span>
<span>]</span><span>)</span>

db.getCollection<span>(</span><span>'company_profile'</span><span>)</span>.aggregate<span>(</span><span>[</span>
	<span>{</span><span>$group</span>:<span>{</span>_id:<span>"<span>$domain</span>"</span>,num:<span>{</span><span>$sum</span>:1<span>}</span><span>}</span><span>}</span>,
	<span>{</span><span>$sort</span>:<span>{</span>num:-1<span>}</span><span>}</span>,
	<span>{</span><span>$limit</span>:100<span>}</span>
<span>]</span><span>)</span>


</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h5 id="createindex-接收可选参数-可选参数列表如下" tabindex="-1"> createIndex() 接收可选参数，可选参数列表如下：</h5>
<table>
<thead>
<tr>
<th style="text-align:left">Parameter</th>
<th style="text-align:left">Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">background</td>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">建索引过程会阻塞其它数据库操作，background可指定以后台方式创建索引，即增加 &quot;background&quot; 可选参数。 &quot;background&quot; 默认值为<strong>false</strong>。</td>
</tr>
<tr>
<td style="text-align:left">unique</td>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">建立的索引是否唯一。指定为true创建唯一索引。默认值为<strong>false</strong>.</td>
</tr>
<tr>
<td style="text-align:left">name</td>
<td style="text-align:left">string</td>
<td style="text-align:left">索引的名称。如果未指定，MongoDB的通过连接索引的字段名和排序顺序生成一个索引名称。</td>
</tr>
<tr>
<td style="text-align:left">dropDups</td>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">**3.0+版本已废弃。**在建立唯一索引时是否删除重复记录,指定 true 创建唯一索引。默认值为 <strong>false</strong>.</td>
</tr>
<tr>
<td style="text-align:left">sparse</td>
<td style="text-align:left">Boolean</td>
<td style="text-align:left">对文档中不存在的字段数据不启用索引；这个参数需要特别注意，如果设置为true的话，在索引字段中不会查询出不包含对应字段的文档.。默认值为 <strong>false</strong>.</td>
</tr>
<tr>
<td style="text-align:left">expireAfterSeconds</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">指定一个以秒为单位的数值，完成 TTL设定，设定集合的生存时间。</td>
</tr>
<tr>
<td style="text-align:left">v</td>
<td style="text-align:left">index version</td>
<td style="text-align:left">索引的版本号。默认的索引版本取决于mongod创建索引时运行的版本。</td>
</tr>
<tr>
<td style="text-align:left">weights</td>
<td style="text-align:left">document</td>
<td style="text-align:left">索引权重值，数值在 1 到 99,999 之间，表示该索引相对于其他索引字段的得分权重。</td>
</tr>
<tr>
<td style="text-align:left">default_language</td>
<td style="text-align:left">string</td>
<td style="text-align:left">对于文本索引，该参数决定了停用词及词干和词器的规则的列表。 默认为英语</td>
</tr>
<tr>
<td style="text-align:left">language_override</td>
<td style="text-align:left">string</td>
<td style="text-align:left">对于文本索引，该参数指定了包含在文档中的字段名，语言覆盖默认的language，默认值为 language.</td>
</tr>
</tbody>
</table>
<h5 id="通过explian-分析执行情况" tabindex="-1"> 通过<a href="https://docs.mongodb.com/manual/reference/method/cursor.explain/" target="_blank" rel="noopener noreferrer">explian()</a>分析执行情况</h5>
<p>db.getCollection('companyTmp').find({c:14298217,d:&quot;20210829&quot;}).explain()</p>
<div><pre><code><span>{</span>
    <span>"queryPlanner"</span> <span>:</span> <span>{</span>
        <span>"plannerVersion"</span> <span>:</span> <span>1</span>,
        <span>"namespace"</span> <span>:</span> <span>"jobui_tmp.companyTmp"</span>,
        <span>"indexFilterSet"</span> <span>:</span> false,
        <span>"parsedQuery"</span> <span>:</span> <span>{</span>
            <span>"<span>$and</span>"</span> <span>:</span> <span>[</span> 
                <span>{</span>
                    <span>"c"</span> <span>:</span> <span>{</span>
                        <span>"<span>$eq</span>"</span> <span>:</span> <span>14298217.0</span>
                    <span>}</span>
                <span>}</span>, 
                <span>{</span>
                    <span>"d"</span> <span>:</span> <span>{</span>
                        <span>"<span>$eq</span>"</span> <span>:</span> <span>"20210829"</span>
                    <span>}</span>
                <span>}</span>
            <span>]</span>
        <span>}</span>,
        <span>"winningPlan"</span> <span>:</span> <span>{</span>
            <span>"stage"</span> <span>:</span> <span>"FETCH"</span>,
            <span>"inputStage"</span> <span>:</span> <span>{</span>
                <span>"stage"</span> <span>:</span> <span>"IXSCAN"</span>,
                <span>"keyPattern"</span> <span>:</span> <span>{</span>
                    <span>"c"</span> <span>:</span> <span>1.0</span>,
                    <span>"d"</span> <span>:</span> <span>-1.0</span>
                <span>}</span>,
                <span>"indexName"</span> <span>:</span> <span>"c_1_d_-1"</span>,
                <span>"isMultiKey"</span> <span>:</span> false,
                <span>"direction"</span> <span>:</span> <span>"forward"</span>,
                <span>"indexBounds"</span> <span>:</span> <span>{</span>
                    <span>"c"</span> <span>:</span> <span>[</span> 
                        <span>"[14298217.0, 14298217.0]"</span>
                    <span>]</span>,
                    <span>"d"</span> <span>:</span> <span>[</span> 
                        <span>"[<span title="\&quot;">\"</span>20210829<span title="\&quot;">\"</span>, <span title="\&quot;">\"</span>20210829<span title="\&quot;">\"</span>]"</span>
                    <span>]</span>
                <span>}</span>
            <span>}</span>
        <span>}</span>,
        <span>"rejectedPlans"</span> <span>:</span> <span>[</span><span>]</span>
    <span>}</span>,
    <span>"serverInfo"</span> <span>:</span> <span>{</span>
        <span>"host"</span> <span>:</span> <span>"localhost.localdomain"</span>,
        <span>"port"</span> <span>:</span> <span>12000</span>,
        <span>"version"</span> <span>:</span> <span>"3.0.7"</span>,
        <span>"gitVersion"</span> <span>:</span> <span>"6ce7cbe8c6b899552dadd907604559806aa2e9bd"</span>
    <span>}</span>,
    <span>"ok"</span> <span>:</span> <span>1.0</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="php7操作mongodb类" tabindex="-1"> php7操作mongodb类</h3>
<div><pre><code><span><span>&lt;?php</span>
<span>/**
 * desc
 * version    1.0
 * author    Zax
 * date    2021/12/22
 */</span>


<span>$manager</span> <span>=</span> <span>new</span> <span>MongoDB<span>\</span>Driver<span>\</span>Manager</span><span>(</span><span>"mongodb://192.168.1.35:12000"</span><span>)</span><span>;</span>

<span>//插入数据</span>
<span>$bulk</span> <span>=</span> <span>new</span> <span>MongoDB<span>\</span>Driver<span>\</span>BulkWrite</span><span>;</span>
<span>$bulk</span><span>-></span><span>insert</span><span>(</span><span>[</span><span>'x'</span> <span>=></span> <span>1</span><span>,</span> <span>'name'</span><span>=></span><span>'菜鸟教程'</span><span>,</span> <span>'url'</span> <span>=></span> <span>'http://www.runoob.com'</span><span>]</span><span>)</span><span>;</span>
<span>$bulk</span><span>-></span><span>insert</span><span>(</span><span>[</span><span>'x'</span> <span>=></span> <span>2</span><span>,</span> <span>'name'</span><span>=></span><span>'Google'</span><span>,</span> <span>'url'</span> <span>=></span> <span>'http://www.google.com'</span><span>]</span><span>)</span><span>;</span>
<span>$bulk</span><span>-></span><span>insert</span><span>(</span><span>[</span><span>'x'</span> <span>=></span> <span>3</span><span>,</span> <span>'name'</span><span>=></span><span>'taobao'</span><span>,</span> <span>'url'</span> <span>=></span> <span>'http://www.taobao.com'</span><span>]</span><span>)</span><span>;</span>
<span>$manager</span><span>-></span><span>executeBulkWrite</span><span>(</span><span>'test.sites'</span><span>,</span> <span>$bulk</span><span>)</span><span>;</span>

<span>$filter</span> <span>=</span> <span>[</span><span>'x'</span> <span>=></span> <span>[</span><span>'$gt'</span> <span>=></span> <span>1</span><span>]</span><span>]</span><span>;</span>
<span>$options</span> <span>=</span> <span>[</span>
	<span>'projection'</span> <span>=></span> <span>[</span><span>'_id'</span> <span>=></span> <span>0</span><span>]</span><span>,</span>
	<span>'sort'</span> <span>=></span> <span>[</span><span>'x'</span> <span>=></span> <span>-</span><span>1</span><span>]</span><span>,</span>
<span>]</span><span>;</span>

<span>// 查询数据</span>
<span>$query</span> <span>=</span> <span>new</span> <span>MongoDB<span>\</span>Driver<span>\</span>Query</span><span>(</span><span>$filter</span><span>,</span> <span>$options</span><span>)</span><span>;</span>
<span>$cursor</span> <span>=</span> <span>$manager</span><span>-></span><span>executeQuery</span><span>(</span><span>'test.sites'</span><span>,</span> <span>$query</span><span>)</span><span>;</span>

<span>foreach</span> <span>(</span><span>$cursor</span> <span>as</span> <span>$document</span><span>)</span> <span>{</span>
	<span>print_r</span><span>(</span><span>$document</span><span>)</span><span>;</span>
<span>}</span>


<span>//更新数据</span>
<span>$bulk</span> <span>=</span> <span>new</span> <span>MongoDB<span>\</span>Driver<span>\</span>BulkWrite</span><span>;</span>
<span>$bulk</span><span>-></span><span>update</span><span>(</span>
	<span>[</span><span>'x'</span> <span>=></span> <span>2</span><span>]</span><span>,</span>
	<span>[</span><span>'$set'</span> <span>=></span> <span>[</span><span>'name'</span> <span>=></span> <span>'菜鸟工具'</span><span>,</span> <span>'url'</span> <span>=></span> <span>'tool.runoob.com'</span><span>]</span><span>]</span><span>,</span>
	<span>[</span><span>'multi'</span> <span>=></span> <span>false</span><span>,</span> <span>'upsert'</span> <span>=></span> <span>false</span><span>]</span>
<span>)</span><span>;</span>

<span>$writeConcern</span> <span>=</span> <span>new</span> <span>MongoDB<span>\</span>Driver<span>\</span>WriteConcern</span><span>(</span><span>MongoDB<span>\</span>Driver<span>\</span>WriteConcern</span><span>::</span><span>MAJORITY</span><span>,</span> <span>1000</span><span>)</span><span>;</span>
<span>$result</span> <span>=</span> <span>$manager</span><span>-></span><span>executeBulkWrite</span><span>(</span><span>'test.sites'</span><span>,</span> <span>$bulk</span><span>,</span> <span>$writeConcern</span><span>)</span><span>;</span>


<span>//删除数据</span>
<span>$bulk</span> <span>=</span> <span>new</span> <span>MongoDB<span>\</span>Driver<span>\</span>BulkWrite</span><span>;</span>
<span>$bulk</span><span>-></span><span>delete</span><span>(</span><span>[</span><span>'likes'</span> <span>=></span><span>[</span><span>'$gt'</span> <span>=></span> <span>30</span><span>]</span><span>]</span><span>,</span> <span>[</span><span>'limit'</span> <span>=></span> <span>0</span><span>]</span><span>)</span><span>;</span>   <span>// limit 为 1 时，删除第一条匹配数据</span>
<span>//$bulk->delete(['x' => 2], ['limit' => 0]);   // limit 为 0 时，删除所有匹配数据</span>

<span>$writeConcern</span> <span>=</span> <span>new</span> <span>MongoDB<span>\</span>Driver<span>\</span>WriteConcern</span><span>(</span><span>MongoDB<span>\</span>Driver<span>\</span>WriteConcern</span><span>::</span><span>MAJORITY</span><span>,</span> <span>1000</span><span>)</span><span>;</span>
<span>$result</span> <span>=</span> <span>$manager</span><span>-></span><span>executeBulkWrite</span><span>(</span><span>'jobui_tmp.autoRunRecord'</span><span>,</span> <span>$bulk</span><span>,</span> <span>$writeConcern</span><span>)</span><span>;</span>

<span>exit</span><span>(</span><span>)</span><span>;</span>


<span>//php5</span>

<span>$m</span> <span>=</span> <span>new</span> <span>MongoClient</span><span>(</span><span>'mongodb://192.168.1.24:27017'</span><span>)</span><span>;</span> <span>// 连接默认主机和端口为：mongodb://localhost:27017</span>
<span>$db</span> <span>=</span> <span>$m</span><span>-></span><span>count</span><span>;</span> <span>// 选择一个数据库</span>
<span>$collection</span> <span>=</span> <span>$db</span><span>-></span><span>BlackList</span><span>;</span> <span>// 选择集合</span>

<span>//插入</span>
<span>//$db = $m->test; // 获取名称为 "test" 的数据库</span>
<span>//$collection = $db->createCollection("runoob");</span>
<span>//echo "集合创建成功";</span>
<span>//$collection = $db->runoob; // 选择集合</span>
<span>//$document = array(</span>
<span>//	"title" => "MongoDB",</span>
<span>//	"description" => "database",</span>
<span>//	"likes" => 100,</span>
<span>//	"url" => "http://www.runoob.com/mongodb/",</span>
<span>//	"by", "菜鸟教程"</span>
<span>//);</span>
<span>//$collection->insert($document);</span>
<span>//echo "数据插入成功";</span>


<span>//$collection = $db->runoob; // 选择集合</span>

<span>$cursor</span> <span>=</span> <span>$collection</span><span>-></span><span>find</span><span>(</span><span>[</span><span>'f'</span> <span>=></span> <span>'true'</span><span>]</span><span>)</span><span>;</span>
<span>echo</span> <span>'&lt;pre>'</span><span>;</span>
<span>while</span><span>(</span><span>$doc</span> <span>=</span> <span>$cursor</span><span>-></span><span>getNext</span><span>(</span><span>)</span><span>)</span> <span>{</span><span>//循环读取每个匹配的文档</span>
	<span>print_r</span><span>(</span><span>$doc</span><span>)</span><span>;</span>
<span>}</span>

<span>echo</span> <span>'&lt;pre>'</span><span>;</span>
<span>print_r</span><span>(</span><span>$cursor</span><span>)</span><span>;</span>
<span>exit</span><span>(</span><span>)</span><span>;</span>

</span></code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="mongo的aggregate聚合操作" tabindex="-1"> mongo的aggregate聚合操作</h3>
<h4 id="mongodb中聚合-aggregate-的具体使用结合php" tabindex="-1"> mongoDB中聚合(aggregate)的具体使用结合PHP</h4>
<p>最近在学习mongoDB的使用，本文来介绍一下其中aggregate的具体使用</p>
<p>先来看一个分组的例子，本例中<code>$group</code>是一个管道操作符，获得的结果可以接着输出到下一个管道，而内部的<code>$sum</code>是一个表达式操作符。</p>
<h4 id="用-group-举个例子" tabindex="-1"> 用<code>$group</code> 举个例子</h4>
<div><pre><code>将document分组，用作统计结果

    db.Ubisoft.aggregate([ // aggregate方法接收的是一个数组
        {
            $group: {
                _id: '$time', 
                num: {$sum: 1}
            }
        }
    ])
    // 这里的_id字段表示你要基于哪个字段来进行分组(即制定字段值相同的为一组)，这里的$time就表示要基于time字段来进行分组

    // 下面的num字段的值$sum: 1表示的是获取满足time字段相同的这一组的数量乘以后面给定的值(本例为1，那么就是同组的数量)。
12345678910111213
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>那么看完这个例子之后，mongoDB中还有其他的一些管道操作符和表达式操作符：</p>
<h4 id="管道操作符" tabindex="-1"> 管道操作符</h4>
<table>
<thead>
<tr>
<th style="text-align:left">常用管道</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">$group</td>
<td style="text-align:left">将collection中的document分组，可用于统计结果</td>
</tr>
<tr>
<td style="text-align:left">$match</td>
<td style="text-align:left">过滤数据，只输出符合结果的文档</td>
</tr>
<tr>
<td style="text-align:left">$project</td>
<td style="text-align:left">修改输入文档的结构(例如重命名，增加、删除字段，创建结算结果等)</td>
</tr>
<tr>
<td style="text-align:left">$sort</td>
<td style="text-align:left">将结果进行排序后输出</td>
</tr>
<tr>
<td style="text-align:left">$limit</td>
<td style="text-align:left">限制管道输出的结果个数</td>
</tr>
<tr>
<td style="text-align:left">$skip</td>
<td style="text-align:left">跳过制定数量的结果，并且返回剩下的结果</td>
</tr>
<tr>
<td style="text-align:left">$unwind</td>
<td style="text-align:left">将数组类型的字段进行拆分</td>
</tr>
</tbody>
</table>
<h4 id="表达式操作符" tabindex="-1"> 表达式操作符</h4>
<table>
<thead>
<tr>
<th style="text-align:left">常用表达式</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">$sum</td>
<td style="text-align:left">计算总和，{KaTeX parse error: Expected 'EOF', got '}' at position 7: sum: 1}̲表示返回总和×1的值(即总和的…sum: ‘$制定字段’}也能直接获取制定字段的值的总和</td>
</tr>
<tr>
<td style="text-align:left">$avg</td>
<td style="text-align:left">平均值</td>
</tr>
<tr>
<td style="text-align:left">$min</td>
<td style="text-align:left">min</td>
</tr>
<tr>
<td style="text-align:left">$max</td>
<td style="text-align:left">max</td>
</tr>
<tr>
<td style="text-align:left">$push</td>
<td style="text-align:left">将结果文档中插入值到一个数组中</td>
</tr>
<tr>
<td style="text-align:left">$first</td>
<td style="text-align:left">根据文档的排序获取第一个文档数据</td>
</tr>
<tr>
<td style="text-align:left">$last</td>
<td style="text-align:left">同理，获取最后一个数据</td>
</tr>
</tbody>
</table>
<p>了解完这些操作符之后，继续拿<code>$group</code>来试试看：
我们现在有一个名为Ubisoft的一个collection，内部的文档为：</p>
<div><pre><code>/* 1 */
{
    "_id" : ObjectId("5b0cf67270e4fa02d31de42e"),
    "name" : "rainbowSix Siege",
    "time" : 400.0
}

/* 2 */
{
    "_id" : ObjectId("5b0cf69270e4fa02d31de42f"),
    "name" : "Assassin's creed",
    "time" : 20.0
}

/* 3 */
{
    "_id" : ObjectId("5b0cf6ad70e4fa02d31de430"),
    "name" : "ghost Recon",
    "time" : 0.0
}

/* 4 */
{
    "_id" : ObjectId("5b0d14c870e4fa02d31de436"),
    "name" : "farCry",
    "time" : 0.0
}
123456789101112131415161718192021222324252627
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>我们现在来试试其他的表达式操作符：</p>
<div><pre><code>  db.Ubisoft.aggregate([
       {
           $group: {
               _id: '$time',
               gameName: {$push: '$name'}
           }
       }
   ]) 
12345678
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>返回结果为：</p>
<div><pre><code>/* 1 */
{
    "_id" : 20.0,
    "gameName" : [ 
        "Assassin's creed"
    ]
}

/* 2 */
{
    "_id" : 0.0,
    "gameName" : [ 
        "ghost Recon", 
        "farCry"
    ]
}

/* 3 */
{
    "_id" : 400.0,
    "gameName" : [ 
        "rainbowSix Siege"
    ]
}
123456789101112131415161718192021222324
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>可以看到time字段相同的document被分为了一组，而且使用$push表达式，将我们制定的document的name字段的值也放到了一个数组中作为我们在mongoDB语句中制定的gameName的值。</p>
<p>另外<code>$group</code>中可以制定<code>_id:null</code>, 即可以把所有的document分为一组，可以用于计算平均值之类的操作</p>
<p>我们可以用<code>$</code>指定字段来表示选定的document的field,另外可以使用<code>$$ROOT</code>来表示选定的document的所有内容（例如:<code>chosenDocument: {$push: '$$ROOT'}</code>）</p>
<p>上述例子基本介绍了表达式操作符的用法。</p>
<p>接着来看<code>$match</code></p>
<h4 id="match" tabindex="-1"> $match</h4>
<div><pre><code> db.Ubisoft.aggregate([
        {
            $match: {
                time: {$gte: 20} //选取time字段 >=20的document
            }
        }
    ])
1234567
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>这就拿到了所有time&gt;=20的document,然后可以通过再接个管道来进行其他操作，比如说我们再接一个<code>$group</code>来进行分组，显示筛选出来的所有time&gt;=20的document的个数。</p>
<div><pre><code> db.Ubisoft.aggregate([
        {
            $match: {
                time: {$gte: 20}
            }
        },
        {
            $group: {
                _id: null, // _id: null表示全选
                totalNum: {$sum: 1}
            }
        }
    ])
12345678910111213
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>输出结果为：</p>
<div><pre><code>/* 1 */
{
    "_id" : null,
    "totalNum" : 2.0
}
12345
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>可以看到time&gt;=20的document的个数为2</p>
<h4 id="project投影" tabindex="-1"> project投影</h4>
<p>修改输入文档的结构(例如重命名，增加、删除字段，创建结算结果等)</p>
<p><code>$project</code>和直接使用<code>find()</code>的写法一样：</p>
<div><pre><code>db.Ubisoft.aggregate([
    {
        $project: {
            _id: 0,  //不显示_id字段
        }
    }
])
1234567
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>和我们直接写<code>db.Ubisoft.find({},{'_id': 0})</code>写法一样
输出结果为：</p>
<div><pre><code>/* 1 */
{
    "name" : "rainbowSix Siege",
    "time" : 400.0
}

/* 2 */
{
    "name" : "Assassin's creed",
    "time" : 20.0
}

/* 3 */
{
    "name" : "ghost Recon",
    "time" : 0.0
}

/* 4 */
{
    "name" : "farCry",
    "time" : 0.0
}
1234567891011121314151617181920212223
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>可以看到没有<code>_id</code>字段了。</p>
<p>那么我们现在如果想拿到所有time&gt;=20的document的name字段的话，可以把管道搭配起来用：</p>
<div><pre><code>db.Ubisoft.aggregate([
    {
        $match: {
            time: {$gte: 20}
        }
    },
    {
        $project: {
            _id: 0, // _id不显示
            name: 1 // name是要显示的
        }
    },
    {
        $group: {
            _id: null,
            name: {$push: '$name'}
        }
    }
])
12345678910111213141516171819
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>输出结果为：</p>
<div><pre><code>/* 1 */
{
    "_id" : null,
    "name" : [ 
        "rainbowSix Siege", 
        "Assassin's creed"
    ]
}
12345678
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h4 id="sort" tabindex="-1"> $sort</h4>
<p><code>$sort</code>和我们find()中排序的写法也是一样的。</p>
<p>现在我们想将所有的document按照time降序来排列的话：</p>
<p>和<code>db.Ubisoft.find().sort({time: -1})</code>写法是一样的:</p>
<div><pre><code>db.Ubisoft.aggregate([
    {
        $sort: {
            time: -1
        }
    }
])
1234567
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>同理，<code>$sort</code>也可以和其他管道搭配使用</p>
<h4 id="limit-skip" tabindex="-1"> $limit $skip</h4>
<p>和<code>limit()</code>以及<code>skip()</code>的写法也是一样的。</p>
<div><pre><code>db.Ubisoft.find().skip(1).limit(2)
1
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>使用聚合可以写成：</p>
<div><pre><code>db.Ubisoft.aggregate([
    {
        $skip: 1
    },
    {
        $limit: 2
    }
])
12345678
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>limit和skip搭配使用可以达到分页的效果。</p>
<p>注意先写skip在写limit</p>
<h4 id="unwind" tabindex="-1"> $unwind</h4>
<p><code>$unwind</code>管道可以document中的数组类型的字段进行拆分，每条包含数组中的一个值。</p>
<ul>
<li>基本使用
在Ubisoft这个集合里新增如下一条document:</li>
</ul>
<div><pre><code>/* 5 */
{
    "_id" : ObjectId("5b0e242ed85f6f9cc56da7cc"),
    "name" : "gameList",
    "list" : [ 
        "dota2", 
        "csgo", 
        "ow"
    ]
}
12345678910
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>我们针对这个document中的list字段来进行<code>$unwind</code></p>
<div><pre><code>db.Ubisoft.aggregate([
    {
        $unwind: '$list' // 指定list字段
    }
])
12345
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>输出结果为：</p>
<div><pre><code>/* 1 */
{
    "_id" : ObjectId("5b0e242ed85f6f9cc56da7cc"),
    "name" : "gameList",
    "list" : "dota2"
}

/* 2 */
{
    "_id" : ObjectId("5b0e242ed85f6f9cc56da7cc"),
    "name" : "gameList",
    "list" : "csgo"
}

/* 3 */
{
    "_id" : ObjectId("5b0e242ed85f6f9cc56da7cc"),
    "name" : "gameList",
    "list" : "ow"
}
1234567891011121314151617181920
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>可以看到unwind是将文档中的数组字段进行拆分，如果有其他文档的list字段也是数组，也会一并拆分。</p>
<ul>
<li>特殊情况下的unwind(空数组，null,非数组，无指定字段)</li>
</ul>
<p>针对特殊情况，新建一个colletion,内容为：</p>
<div><pre><code>/* 1 */
{
    "_id" : ObjectId("5b0e27fdd85f6f9cc56da7ce"),
    "list" : null
}

/* 2 */
{
    "_id" : ObjectId("5b0e2827d85f6f9cc56da7cf"),
    "list" : []
}

/* 3 */
{
    "_id" : ObjectId("5b0e2834d85f6f9cc56da7d0"),
    "list" : "notArray"
}

/* 4 */
{
    "_id" : ObjectId("5b0e2844d85f6f9cc56da7d1")
}
12345678910111213141516171819202122
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>来进行<code>$unwind</code>，</p>
<div><pre><code>db.unwind.aggregate([
    {
        $unwind: '$list'
    }
])
12345
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>输出结果为：</p>
<div><pre><code>/* 1 */
{
    "_id" : ObjectId("5b0e2834d85f6f9cc56da7d0"),
    "list" : "notArray"
}
12345
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>可以看到<code>[]</code>,<code>null</code>,以及无指定字段的数据都丢失了，
为了不丢失数据，我们可以写成：</p>
<div><pre><code>db.unwind.aggregate([
    {
        $unwind: {
            path: '$list', // path是指定字段
            preserveNullAndEmptyArrays: true //该属性为true即保留
        }
    }
])
12345678
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>这次输出结果就保留了null以及空数组，值得关注的就是<code>preserveNullAndEmptyArrays</code>这个属性，为true的时候就保留。</p>
<p>下面结合PHP 代码</p>
<div><pre><code>//$server 根据自己的服务器来
$mongo =  new \MongoClient($server, array('connect'=>true));// 立即连接

$db = $mongo->colName;//选择数据库
$collection = $db->file_log;//选择文档集合

$filter["status"] = array("\$in" => array(0, 2, 5)); 
$filter["a_id"] = array("\$eq" => $a_id);
$group = array("_id" => array(
                "md5" => "\$md5",
                "path" => "\$path",
                "a_id"=>"\$a_id"
            ),
                "time" => array("\$last" => "\$found_time"),
                "l_id" => array("\$last" => "\$_id"),
                "v_name" => array("\$last" => "\$v_name"),
                "c_iso_key" => array("\$last" => "\$c_iso_key"),
                "status" => array("\$last" => "\$status"),
                "h_msg" => array("\$last" => "\$h_msg"),
                "r_level" => array("\$last" => "\$r_level"),
            );
$sort = array("time" => 1); //根据时间排序
$limit = 5;
//即以md5、path、a_id分组获取字段为found_time、_id、v_name 最后一个数据、时间倒叙、取出5条
$res = $collection->aggregate(array('$match' => $filter),array('$group' => $group),array('$sort' => $sort),array('$limit'=>(int)$limit));
12345678910111213141516171819202122232425
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>字段名</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>_id:</td>
<td>15110</td>
</tr>
<tr>
<td>cid</td>
<td>1236</td>
</tr>
<tr>
<td>n</td>
<td>10</td>
</tr>
<tr>
<td>d</td>
<td>20220304</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>字段名</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>_id:</td>
<td>15110</td>
</tr>
<tr>
<td>cid</td>
<td>[1236,1239,78234]</td>
</tr>
<tr>
<td>d</td>
<td>20220304</td>
</tr>
</tbody>
</table>
]]></content:encoded>
    </item>
    <item>
      <title>mysql</title>
      <link>https://newzone.top/services/mysql.html</link>
      <guid>https://newzone.top/services/mysql.html</guid>
      <source url="https://newzone.top/rss.xml">mysql</source>
      <pubDate>Thu, 25 Aug 2022 09:01:21 GMT</pubDate>
      <content:encoded><![CDATA[<h1 id="mysql" tabindex="-1"> mysql</h1>
<h3 id="连接" tabindex="-1"> 连接</h3>
<div><pre><code>mysql
</code></pre><div aria-hidden="true"><div></div></div></div><p>导入数据</p>
<div><pre><code>/web/software/mysql/bin/mysql <span>-u</span> baicai_w <span>-p</span> zabbix <span>&lt;</span> zabbix.sql
</code></pre><div aria-hidden="true"><div></div></div></div>]]></content:encoded>
    </item>
  </channel>
</rss>